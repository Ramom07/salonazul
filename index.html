<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salón Azul | Sistema de Gestión de Contratos e Inventario</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1a237e;
            --secondary: #0d47a1;
            --accent: #2196f3;
            --light: #bbdefb;
            --dark: #0d1b3e;
            --success: #4caf50;
            --warning: #ff9800;
            --info: #9c27b0;
            --danger: #f44336;
            --shine: linear-gradient(45deg, #1a237e, #0d47a1, #2196f3, #64b5f6);
            --blue-gradient: linear-gradient(135deg, #1a237e 0%, #0d47a1 50%, #2196f3 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            width: 90%;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header con efecto de vidrio */
        header {
            background: rgba(26, 35, 126, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* ESTILOS DEL LOGO MEJORADOS */
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-img {
            height: 50px;
            width: auto;
            max-width: 150px;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        
        .logo-img:hover {
            transform: scale(1.05);
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: 800;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        /* Hero Section */
        .hero {
            background: linear-gradient(rgba(13, 27, 62, 0.8), rgba(13, 27, 62, 0.8)), url('https://images.unsplash.com/photo-1511795409834-ef04bbd61622?ixlib=rb-4.0.3&auto=format&fit=crop&w=1769&q=80') center/cover no-repeat;
            color: white;
            text-align: center;
            padding: 8rem 1rem;
            position: relative;
            overflow: hidden;
            min-height: 100vh;
            display: flex;
            align-items: center;
        }
        
        .hero-content {
            position: relative;
            z-index: 3;
            width: 100%;
        }
        
        .hero h2 {
            font-size: 3rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
            animation: fadeInUp 1s ease-out;
        }
        
        .hero p {
            font-size: 1.3rem;
            max-width: 700px;
            margin: 0 auto 2rem;
            animation: fadeInUp 1.5s ease-out;
        }
        
        .btn {
            display: inline-block;
            background: var(--blue-gradient);
            color: white;
            padding: 1rem 2rem;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
            position: relative;
            overflow: hidden;
            animation: fadeInUp 2s ease-out;
        }
        
        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(33, 150, 243, 0.6);
        }
        
        /* Login Section */
        .login-section {
            background-color: white;
            padding: 5rem 0;
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .section-title h2 {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 1rem;
            position: relative;
            display: inline-block;
        }
        
        .section-title h2::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: var(--shine);
            background-size: 200% 100%;
            animation: shine 3s infinite;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
        }
        
        .login-card {
            background-color: var(--light);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
            width: 100%;
            max-width: 500px;
        }
        
        .login-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }
        
        .login-header {
            background: var(--primary);
            color: white;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .login-header i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .login-body {
            padding: 2rem;
            position: relative;
            z-index: 2;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--primary);
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2), 0 0 0 3px rgba(33, 150, 243, 0.3);
            border-color: var(--accent);
        }
        
        .user-info-box {
            background-color: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--accent);
            display: none;
        }
        
        .user-info-box.show {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-info-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-info-title i {
            color: var(--accent);
        }
        
        .user-info-description {
            margin-bottom: 1rem;
            color: #555;
        }
        
        .user-type-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            background-color: rgba(33, 150, 243, 0.2);
            color: var(--accent);
        }
        
        .login-instructions {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #666;
            font-size: 0.95rem;
            padding: 0.5rem;
            background-color: rgba(33, 150, 243, 0.05);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
        }
        
        /* Paneles de administración */
        .admin-panel {
            display: none;
            padding: 2rem 0;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .admin-header {
            background: var(--blue-gradient);
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .admin-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-nav {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .admin-nav button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .admin-nav button:hover, .admin-nav button.active {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .admin-section {
            display: none;
        }
        
        .admin-section.active {
            display: block;
        }
        
        .section-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        /* Layout para crear contrato */
        .contract-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        @media (max-width: 1024px) {
            .contract-layout {
                grid-template-columns: 1fr;
            }
        }
        
        .form-column {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-column {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        /* Estilos para calendario - CORREGIDO */
        .calendar-container {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            height: 800px; /* Cambiado de max-height a height fija */
            width: 100%;
            overflow: hidden;
        }
        
        .calendar-container h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .calendar-container h3 i {
            color: var(--accent);
        }
        
        #calendar {
            height: 100% !important;
            width: 100% !important;
            font-size: 14px;
        }
        
        .fc {
            height: 100% !important;
        }
        
        .fc-view-container {
            height: calc(100% - 60px) !important;
        }
        
        .fc-toolbar {
            margin-bottom: 1em !important;
        }
        
        .fc-event {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 12px;
            margin: 1px 0;
        }
        
        .fc-day-grid-event {
            margin: 1px 2px !important;
        }
        
        /* Estilos para vista previa del contrato */
        .contract-preview-container {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-height: 700px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        
        .contract-preview-container h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .contract-preview-container h3 i {
            color: var(--success);
        }
        
        .contract-preview {
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            padding: 1rem;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .contract-preview h1, .contract-preview h2, .contract-preview h3 {
            color: #1a237e;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .contract-preview .contract-header {
            text-align: center;
            border-bottom: 2px solid #1a237e;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .contract-preview .section {
            margin-bottom: 1.5rem;
        }
        
        .contract-preview .clause {
            margin-bottom: 1rem;
            padding-left: 1rem;
            border-left: 3px solid #0d47a1;
        }
        
        .contract-preview .signature-section {
            margin-top: 3rem;
            padding-top: 1.5rem;
            border-top: 1px solid #333;
        }
        
        .contract-preview .signature-line {
            display: inline-block;
            width: 300px;
            border-bottom: 1px solid #333;
            margin: 0 1rem;
        }
        
        /* Estilos para campos de pago */
        .payment-fields {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }
        
        .payment-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #ddd;
        }
        
        .payment-row:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .payment-label {
            font-weight: 600;
            color: var(--primary);
        }
        
        .payment-value {
            font-weight: 600;
            color: var(--secondary);
            font-size: 1.1rem;
        }
        
        .payment-value.net {
            color: var(--success);
            font-size: 1.2rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f5f7fa;
            font-weight: 600;
            color: var(--primary);
        }
        
        .action-btn {
            background: var(--accent);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            margin-right: 0.5rem;
            margin-bottom: 0.3rem;
        }
        
        .action-btn:hover {
            background: #0d47a1;
        }
        
        .action-btn.delete {
            background: var(--danger);
        }
        
        .action-btn.delete:hover {
            background: #d32f2f;
        }
        
        .action-btn.success {
            background: var(--success);
        }
        
        .action-btn.success:hover {
            background: #388e3c;
        }
        
        .action-btn.whatsapp {
            background: #25D366;
        }
        
        .action-btn.whatsapp:hover {
            background: #128C7E;
        }
        
        .action-btn.warning {
            background: var(--warning);
        }
        
        .action-btn.warning:hover {
            background: #f57c00;
        }
        
        .action-btn.info {
            background: var(--info);
        }
        
        .action-btn.info:hover {
            background: #7b1fa2;
        }
        
        /* Footer */
        footer {
            background: linear-gradient(to bottom, var(--dark), #0a1433);
            color: white;
            padding: 4rem 0 1rem;
            position: relative;
            overflow: hidden;
        }
        
        footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--shine);
            background-size: 200% 100%;
            animation: shine 3s infinite;
        }
        
        .footer-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .copyright {
            text-align: center;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .logo {
                justify-content: center;
            }
            
            .logo-img {
                height: 40px;
            }
            
            .logo h1 {
                font-size: 1.5rem;
            }
            
            .hero h2 {
                font-size: 2.2rem;
            }
            
            .admin-nav {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .login-card {
                max-width: 100%;
            }
            
            .contract-layout {
                grid-template-columns: 1fr;
            }
            
            .payment-row {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .action-btn {
                margin-bottom: 0.5rem;
            }
        }
        
        /* Scroll suave para toda la página */
        html {
            scroll-behavior: smooth;
        }
        
        /* Animación para el botón de inicio de sesión */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .hero .btn {
            margin-top: 2rem;
        }
        
        /* Estilo para agregar servicio */
        .add-service-btn {
            width: 100%;
            margin-top: 1rem;
            background: var(--success);
        }
        
        .add-service-btn:hover {
            background: #388e3c;
        }
        
        /* Estilo para botón cancelar */
        .cancel-btn {
            background: #95a5a6 !important;
            margin-top: 1rem;
        }
        
        .cancel-btn:hover {
            background: #7f8c8d !important;
        }
        
        /* Estilo para botón imprimir */
        .print-btn {
            background: var(--info);
        }
        
        .print-btn:hover {
            background: #7b1fa2;
        }
        
        /* Estilo para método de pago */
        .payment-method-select {
            margin-top: 1rem;
        }
        
        /* Estilo para recibo de impresión */
        .receipt-container {
            display: none;
        }
        
        /* Estilo para mensajes de confirmación */
        .confirmation-message {
            background-color: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }
        
        .confirmation-message.show {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }
        
        .appointment-id {
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        /* Estilos para etiquetas de estado */
        .status-badge {
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-pendiente {
            background-color: rgba(33, 150, 243, 0.2);
            color: var(--accent);
        }
        
        .status-confirmada {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }
        
        .status-cancelada {
            background-color: rgba(244, 67, 54, 0.2);
            color: var(--danger);
        }
        
        .status-completada {
            background-color: rgba(156, 39, 176, 0.2);
            color: var(--info);
        }
        
        /* Modal para detalles de evento */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .close-modal:hover {
            color: var(--danger);
        }
        
        /* Estilos para firma digital */
        .signature-container {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        
        .signature-pad {
            border: 2px dashed #ccc;
            border-radius: 8px;
            background: white;
            cursor: crosshair;
            margin-bottom: 1rem;
        }
        
        .signature-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .signature-preview {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            text-align: center;
        }
        
        .signature-preview img {
            max-width: 100%;
            max-height: 150px;
            border: 1px solid #ddd;
        }
        
        .signature-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1rem;
        }
        
        @media (max-width: 768px) {
            .signature-fields {
                grid-template-columns: 1fr;
            }
        }
        
        /* Estilo para notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            background: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-left: 4px solid var(--success);
        }
        
        .notification.error {
            border-left: 4px solid var(--danger);
        }
        
        .notification.info {
            border-left: 4px solid var(--accent);
        }
        
        .notification-icon {
            font-size: 1.5rem;
        }
        
        .notification.success .notification-icon {
            color: var(--success);
        }
        
        .notification.error .notification-icon {
            color: var(--danger);
        }
        
        .notification.info .notification-icon {
            color: var(--accent);
        }
        
        /* Aviso para adjuntar PDF a WhatsApp */
        .pdf-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 350px;
            padding: 1.5rem;
            border-radius: 10px;
            background: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            transform: translateX(150%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            border-top: 5px solid var(--success);
        }
        
        .pdf-notification.show {
            transform: translateX(0);
        }
        
        .pdf-notification-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        .pdf-notification-header i {
            font-size: 1.5rem;
            color: var(--success);
        }
        
        .pdf-notification-body {
            margin-bottom: 1rem;
        }
        
        .pdf-notification-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .pdf-notification .btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        /* Estilos para campos de contrato específicos */
        .contract-date-fields {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .contract-info-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .contract-clause {
            background: #f0f7ff;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent);
        }
        
        .contract-clause h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .contract-clause p {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }
        
        .contract-clause ul {
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .contract-clause li {
            margin-bottom: 0.3rem;
        }
        
        .contract-prohibitions {
            background: #fff0f0;
            border-left-color: var(--danger);
        }
        
        .contract-prohibitions h4 {
            color: var(--danger);
        }
        
        /* Estilo para el selector de paquetes (REMOVIDO) */
        .package-selector {
            display: none;
        }
        
        .package-option {
            display: none;
        }
        
        /* Estilo para campos de hora */
        .time-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        /* Estilo para información del representante */
        .representative-info {
            background: #f0f7ff;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
            border-left: 4px solid var(--accent);
        }
        
        .representative-info h4 {
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .representative-info h4 i {
            color: var(--accent);
        }
        
        /* Nuevos estilos para edición de contratos y validación de fechas */
        .date-warning {
            background-color: rgba(255, 152, 0, 0.1);
            border: 1px solid var(--warning);
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }
        
        .date-warning.show {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }
        
        .date-warning i {
            color: var(--warning);
            margin-right: 10px;
        }
        
        .date-available {
            background-color: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--success);
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }
        
        .date-available.show {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }
        
        .date-available i {
            color: var(--success);
            margin-right: 10px;
        }
        
        .edit-payment-section {
            background-color: rgba(33, 150, 243, 0.1);
            border: 1px solid var(--accent);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }
        
        .edit-payment-section h4 {
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .edit-payment-section h4 i {
            color: var(--accent);
        }
        
        .payment-history {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #ddd;
        }
        
        .payment-history-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #ddd;
        }
        
        .payment-history-item:last-child {
            border-bottom: none;
        }
        
        .payment-history-date {
            color: #666;
            font-size: 0.9rem;
        }
        
        .payment-history-amount {
            font-weight: 600;
            color: var(--success);
        }
        
        .add-payment-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        @media (max-width: 768px) {
            .add-payment-form {
                grid-template-columns: 1fr;
            }
        }
        
        /* Modal para conflicto de fechas */
        .conflict-modal .modal-content {
            max-width: 600px;
        }
        
        .conflict-details {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid var(--warning);
        }
        
        .conflict-details p {
            margin-bottom: 0.5rem;
        }
        
        .conflict-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }
        
        /* Nuevos estilos para cubremantel */
        .tablecloth-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .tablecloth-color-group {
            display: none;
        }
        
        /* Estilos para inventario */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .inventory-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 4px solid var(--accent);
        }
        
        .inventory-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        .inventory-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        .inventory-header i {
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        .inventory-details {
            margin-top: 1rem;
        }
        
        .inventory-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        
        .inventory-item:last-child {
            border-bottom: none;
        }
        
        .inventory-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: flex-end;
        }
        
        .inventory-form {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
        }
        
        .inventory-form-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 768px) {
            .inventory-form-columns {
                grid-template-columns: 1fr;
            }
        }
        
        .inventory-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .summary-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-top: 4px solid var(--accent);
        }
        
        .summary-card h3 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--secondary);
            margin: 1rem 0;
        }
        
        .low-stock {
            color: var(--danger) !important;
        }
        
        .medium-stock {
            color: var(--warning) !important;
        }
        
        .good-stock {
            color: var(--success) !important;
        }
        
        .stock-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .stock-low {
            background-color: var(--danger);
        }
        
        .stock-medium {
            background-color: var(--warning);
        }
        
        .stock-good {
            background-color: var(--success);
        }
        
        /* Nuevos estilos para estadísticas */
        .statistics-panel {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .statistics-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .statistics-filters label {
            font-weight: 600;
            color: var(--primary);
        }
        
        .statistics-filters select, .statistics-filters input {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .chart-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--accent);
        }
        
        .chart-card h4 {
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-card h4 i {
            color: var(--accent);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-top: 3px solid var(--accent);
        }
        
        .stat-card h5 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .stat-card .value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--secondary);
        }
        
        .stat-card .change {
            font-size: 0.8rem;
            margin-top: 0.3rem;
        }
        
        .positive {
            color: var(--success);
        }
        
        .negative {
            color: var(--danger);
        }
        
        .monthly-breakdown {
            overflow-x: auto;
            margin-top: 1rem;
        }
        
        .monthly-breakdown table {
            width: 100%;
            font-size: 0.9rem;
        }
        
        .monthly-breakdown th {
            background: #f5f7fa;
        }
        
        /* Modal para abonar */
        .payment-modal .modal-content {
            max-width: 500px;
        }
        
        .payment-modal h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .payment-modal h3 i {
            color: var(--success);
        }
        
        .contract-summary {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--accent);
        }
        
        .contract-summary h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .contract-summary p {
            margin-bottom: 0.3rem;
        }
        
        /* Estilos para vista de contrato completo */
        .full-contract-view {
            max-height: 600px;
            overflow-y: auto;
            padding: 1rem;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
        
        /* Estilos para búsqueda y filtros avanzados */
        .advanced-filters {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 1rem;
        }
        
        .search-box input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 2.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .search-box i {
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        
        /* Estilos para tabla de contratos mejorada */
        .contracts-table-container {
            overflow-x: auto;
        }
        
        .contracts-table-container table {
            min-width: 1000px;
        }
        
        .contract-row {
            transition: background 0.3s;
        }
        
        .contract-row:hover {
            background: #f8f9fa;
        }
        
        .contract-status {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .contract-status.pendiente {
            background: rgba(33, 150, 243, 0.2);
            color: var(--accent);
        }
        
        .contract-status.confirmado {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }
        
        .contract-status.completado {
            background: rgba(156, 39, 176, 0.2);
            color: var(--info);
        }
        
        .contract-status.cancelado {
            background: rgba(244, 67, 54, 0.2);
            color: var(--danger);
        }

        /* Nuevo estilo para buscador rápido */
        .quick-search {
            margin: 1rem 0;
            position: relative;
        }

        .quick-search input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 2.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .quick-search i {
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .no-results {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-style: italic;
        }

        .search-highlight {
            background-color: yellow;
            font-weight: bold;
            padding: 2px;
        }
        
        /* Modal para acciones del calendario */
        .calendar-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        
        /* Mejoras para visualización de eventos en calendario */
        .fc-event-title {
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .fc-time {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-container">
            <div class="logo">
                <img src="logosalon.png" alt="Logotipo Salón Azul" class="logo-img">
                <h1>Salón Azul</h1>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero" id="inicio">
        <div class="container hero-content">
            <h2>Sistema de Gestión de Contratos e Inventario</h2>
            <p>Sistema integral para la gestión de contratos e inventario del Salón Azul</p>
            <a href="#login" class="btn">Iniciar Sesión</a>
        </div>
    </section>

    <!-- Login Section -->
    <section class="login-section" id="login">
        <div class="container">
            <div class="section-title">
                <h2>Acceso al Sistema</h2>
                <p>Ingresa tus credenciales para acceder al panel de administración</p>
            </div>
            <div class="login-container">
                <div class="login-card">
                    <div class="login-header">
                        <i class="fas fa-sign-in-alt"></i>
                        <h3>Iniciar Sesión</h3>
                    </div>
                    <div class="login-body">
                        <div class="login-instructions">
                            <p><strong>Instrucciones:</strong> ingresa usuario y contraseña</p>
                        </div>
                        
                        <div class="form-group">
                            <label for="username">Usuario</label>
                            <input type="text" id="username" placeholder="Ingresa tu usuario" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Contraseña</label>
                            <input type="password" id="password" placeholder="Ingresa tu contraseña" required>
                        </div>
                        
                        <!-- Información del usuario que se mostrará después de ingresar credenciales -->
                        <div id="userInfoBox" class="user-info-box">
                            <div class="user-info-title">
                                <i class="fas fa-user-circle"></i>
                                <span id="userTypeText">Administrador del Salón Azul</span>
                            </div>
                            <div class="user-info-description" id="userDescription">
                                Tendrás acceso completo al sistema para gestionar contratos, eventos e inventario.
                            </div>
                            <div id="userBadge" class="user-type-badge">
                                <i class="fas fa-user-shield"></i> Administrador
                            </div>
                        </div>
                        
                        <button type="button" class="btn" id="loginBtn" style="width: 100%; margin-top: 1rem;">Ingresar al Sistema</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Panel de Administración -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-header">
            <div class="container admin-header-container">
                <div class="logo">
                    <i class="fas fa-user-shield"></i>
                    <h2>Panel de Administración - Salón Azul</h2>
                </div>
                <div class="admin-nav">
                    <button class="admin-nav-btn active" data-section="createContract">Crear Contrato</button>
                    <button class="admin-nav-btn" data-section="viewContracts">Ver Contratos</button>
                    <button class="admin-nav-btn" data-section="statistics">Estadísticas</button>
                    <button class="admin-nav-btn" data-section="calendar">Calendario</button>
                    <button class="admin-nav-btn" data-section="inventory">Inventario</button>
                    <button class="btn" id="logoutBtn">Cerrar Sesión</button>
                </div>
            </div>
        </div>
        
        <div class="container">
            <!-- Sección de Crear Contrato -->
            <div class="admin-section active" id="createContractSection">
                <div class="section-title">
                    <h2 id="contractFormTitle">Crear Nuevo Contrato</h2>
                    <p id="contractFormSubtitle">Complete los datos para generar un nuevo contrato de evento</p>
                </div>
                
                <!-- Advertencia de fecha ocupada -->
                <div id="dateWarning" class="date-warning">
                    <p><i class="fas fa-exclamation-triangle"></i> <strong>ADVERTENCIA:</strong> La fecha seleccionada ya está ocupada por otro contrato. Verifique la disponibilidad antes de continuar.</p>
                </div>
                
                <!-- Mensaje de fecha disponible -->
                <div id="dateAvailable" class="date-available">
                    <p><i class="fas fa-check-circle"></i> <strong>DISPONIBLE:</strong> La fecha seleccionada está disponible para el evento.</p>
                </div>
                
                <div class="contract-layout">
                    <!-- Columna izquierda: Formulario de contrato -->
                    <div class="form-column">
                        <form id="createContractForm">
                            <input type="hidden" id="contractId" value="">
                            <input type="hidden" id="isEditing" value="false">
                            
                            <h3>Información del Contratante</h3>
                            <div class="contract-info-fields">
                                <div class="form-group">
                                    <label for="contractorName">Nombre del Contratante *</label>
                                    <input type="text" id="contractorName" placeholder="Nombre completo" required>
                                </div>
                                <div class="form-group">
                                    <label for="contractorPhone">Teléfono *</label>
                                    <input type="tel" id="contractorPhone" placeholder="Número de teléfono" required>
                                </div>
                            </div>
                            
                            <div class="contract-info-fields">
                                <div class="form-group">
                                    <label for="contractorAddress">Domicilio *</label>
                                    <input type="text" id="contractorAddress" placeholder="Dirección completa" required>
                                </div>
                                <div class="form-group">
                                    <label for="celebrantName">Nombre del Festejado *</label>
                                    <input type="text" id="celebrantName" placeholder="Nombre de quien se festeja" required>
                                </div>
                            </div>
                            
                            <h3>Fecha del Contrato</h3>
                            <div class="contract-date-fields">
                                <div class="form-group">
                                    <label for="contractDay">Día *</label>
                                    <input type="number" id="contractDay" min="1" max="31" placeholder="Día" required>
                                </div>
                                <div class="form-group">
                                    <label for="contractMonth">Mes *</label>
                                    <input type="text" id="contractMonth" placeholder="Mes" required>
                                </div>
                                <div class="form-group">
                                    <label for="contractYear">Año *</label>
                                    <input type="number" id="contractYear" min="2025" max="2100" placeholder="Año" required value="2025">
                                </div>
                            </div>
                            
                            <div class="representative-info">
                                <h4><i class="fas fa-user-tie"></i> Información del Representante</h4>
                                <div class="form-group">
                                    <label for="representativeName">Nombre del Representante *</label>
                                    <input type="text" id="representativeName" placeholder="Nombre del representante del salón" required value="Representante de Salón Azul">
                                </div>
                            </div>
                            
                            <h3>Información del Evento</h3>
                            <div class="form-group">
                                <label for="eventType">Tipo de Evento *</label>
                                <select id="eventType" required>
                                    <option value="">Selecciona el tipo de evento</option>
                                    <option value="Boda">Boda</option>
                                    <option value="Quinceañera">Quinceañera</option>
                                    <option value="Cumpleaños">Cumpleaños</option>
                                    <option value="Graduación">Graduación</option>
                                    <option value="Bautizo">Bautizo</option>
                                    <option value="Evento Corporativo">Evento Corporativo</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            
                            <div class="contract-info-fields">
                                <div class="form-group">
                                    <label for="eventDate">Fecha del Evento *</label>
                                    <input type="date" id="eventDate" required>
                                </div>
                                <div class="form-group">
                                    <label for="guestsNumber">Número de Invitados *</label>
                                    <input type="number" id="guestsNumber" min="1" max="500" required>
                                </div>
                            </div>
                            
                            <h3>Horario del Evento</h3>
                            <div class="time-fields">
                                <div class="form-group">
                                    <label for="startTime">Hora de Inicio *</label>
                                    <input type="time" id="startTime" max="18:00" required>
                                    <small style="color: #666; display: block; margin-top: 5px;">Horario máximo de inicio: 6:00 PM</small>
                                </div>
                                <div class="form-group">
                                    <label for="endTime">Hora de Término *</label>
                                    <input type="time" id="endTime" required>
                                </div>
                            </div>
                            
                            <h3>Costo del Evento</h3>
                            <div class="form-group">
                                <label for="baseCost">Costo Base del Evento *</label>
                                    <input type="number" id="baseCost" placeholder="Costo base del evento" min="0" step="100" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="extraHourCost">Costo por Hora Extra *</label>
                                <input type="number" id="extraHourCost" placeholder="Costo por hora extra" min="0" step="50" required value="500">
                            </div>
                            
                            <h3>Cubremantel</h3>
                            <div class="tablecloth-fields">
                                <div class="form-group">
                                    <label for="tablecloth">¿Desea cubremantel?</label>
                                    <select id="tablecloth">
                                        <option value="No">No</option>
                                        <option value="Sí">Sí</option>
                                    </select>
                                </div>
                                <div class="form-group tablecloth-color-group" id="tableclothColorGroup">
                                    <label for="tableclothColor">Color del cubremantel</label>
                                    <input type="text" id="tableclothColor" placeholder="Ej: Blanco, Rojo, etc.">
                                </div>
                            </div>
                            
                            <h3>Servicios Adicionales</h3>
                            <div class="form-group">
                                <label for="additionalServices">Servicios adicionales (separados por coma)</label>
                                <textarea id="additionalServices" rows="3" placeholder="Ej: Fotógrafo, Video, Pantalla, etc."></textarea>
                            </div>
                            
                            <h3>Información de Pago</h3>
                            <div class="payment-fields">
                                <div class="contract-info-fields">
                                    <div class="form-group">
                                        <label for="totalAmount">Total del Contrato *</label>
                                        <input type="number" id="totalAmount" placeholder="Monto total" min="0" step="100" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="advancePayment">Anticipo *</label>
                                        <input type="number" id="advancePayment" placeholder="Monto del anticipo" min="0" step="100" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="balanceDue">Saldo Pendiente</label>
                                    <input type="number" id="balanceDue" placeholder="Saldo pendiente" min="0" step="100" readonly>
                                </div>
                                
                                <div class="form-group payment-method-select">
                                    <label for="paymentMethod">Método de Pago *</label>
                                    <select id="paymentMethod" required>
                                        <option value="">Selecciona método de pago</option>
                                        <option value="Efectivo">Efectivo</option>
                                        <option value="Transferencia">Transferencia</option>
                                        <option value="Depósito">Depósito</option>
                                        <option value="Tarjeta de Crédito">Tarjeta de Crédito</option>
                                        <option value="Tarjeta de Débito">Tarjeta de Débito</option>
                                    </select>
                                </div>
                                
                                <div class="contract-info-fields">
                                    <div class="form-group">
                                        <label for="alcoholExtraCost">Costo extra por alcohol ($/botella)</label>
                                        <input type="number" id="alcoholExtraCost" placeholder="Ej: 200" min="0" value="200">
                                    </div>
                                    <div class="form-group">
                                        <label for="extraGuestCost">Costo extra por invitado adicional</label>
                                        <input type="number" id="extraGuestCost" placeholder="Ej: 450" min="0" value="450">
                                    </div>
                                </div>
                                
                                <div class="payment-row">
                                    <span class="payment-label">Costo Base:</span>
                                    <span class="payment-value" id="displayBaseCost">$0</span>
                                </div>
                                
                                <div class="payment-row">
                                    <span class="payment-label">Costo Hora Extra:</span>
                                    <span class="payment-value" id="displayExtraHourCost">$0</span>
                                </div>
                                
                                <div class="payment-row">
                                    <span class="payment-label">Total:</span>
                                    <span class="payment-value" id="displayTotal">$0</span>
                                </div>
                                
                                <div class="payment-row">
                                    <span class="payment-label">Anticipo:</span>
                                    <span class="payment-value" id="displayAdvance">$0</span>
                                </div>
                                
                                <div class="payment-row">
                                    <span class="payment-label">Saldo Pendiente:</span>
                                    <span class="payment-value net" id="displayBalance">$0</span>
                                </div>
                            </div>
                            
                            <!-- Sección para agregar pagos adicionales (solo en modo edición) -->
                            <div id="editPaymentSection" class="edit-payment-section" style="display: none;">
                                <h4><i class="fas fa-money-bill-wave"></i> Agregar Pago Adicional</h4>
                                <div class="add-payment-form">
                                    <div class="form-group">
                                        <label for="additionalPaymentAmount">Monto adicional</label>
                                        <input type="number" id="additionalPaymentAmount" placeholder="Monto a agregar" min="0" step="100">
                                    </div>
                                    <div class="form-group">
                                        <label for="additionalPaymentMethod">Método de pago</label>
                                        <select id="additionalPaymentMethod">
                                            <option value="Efectivo">Efectivo</option>
                                            <option value="Transferencia">Transferencia</option>
                                            <option value="Depósito">Depósito</option>
                                        </select>
                                    </div>
                                    <button type="button" class="btn success" id="addPaymentBtn" style="align-self: flex-end;">
                                        <i class="fas fa-plus-circle"></i> Agregar
                                    </button>
                                </div>
                                
                                <!-- Historial de pagos adicionales -->
                                <div id="paymentHistory" class="payment-history">
                                    <h5>Historial de Pagos Adicionales</h5>
                                    <div id="paymentHistoryList">
                                        <!-- Los pagos adicionales se mostrarán aquí -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Firma Digital del Contratante -->
                            <h3>Firma del Contratante</h3>
                            <div class="signature-container">
                                <p>Firme en el área siguiente usando el mouse o touchpad:</p>
                                <canvas id="signaturePadContractor" class="signature-pad" width="600" height="200"></canvas>
                                <div class="signature-actions">
                                    <button type="button" class="action-btn" id="clearSignatureContractor">
                                        <i class="fas fa-eraser"></i> Limpiar Firma
                                    </button>
                                    <button type="button" class="action-btn success" id="saveSignatureContractor">
                                        <i class="fas fa-save"></i> Guardar Firma
                                    </button>
                                </div>
                                <div class="signature-preview">
                                    <p>Vista previa de la firma del contratante:</p>
                                    <div id="signaturePreviewContractor">
                                        <p style="color: #666; font-style: italic;">Aún no se ha guardado ninguna firma</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Firma Digital del Representante -->
                            <h3>Firma del Representante del Salón</h3>
                            <div class="signature-container">
                                <p>Firme en el área siguiente usando el mouse o touchpad:</p>
                                <canvas id="signaturePadRepresentative" class="signature-pad" width="600" height="200"></canvas>
                                <div class="signature-actions">
                                    <button type="button" class="action-btn" id="clearSignatureRepresentative">
                                        <i class="fas fa-eraser"></i> Limpiar Firma
                                    </button>
                                    <button type="button" class="action-btn success" id="saveSignatureRepresentative">
                                        <i class="fas fa-save"></i> Guardar Firma
                                    </button>
                                </div>
                                <div class="signature-preview">
                                    <p>Vista previa de la firma del representante:</p>
                                    <div id="signaturePreviewRepresentative">
                                        <p style="color: #666; font-style: italic;">Aún no se ha guardado ninguna firma</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Mensaje de confirmación -->
                            <div id="confirmationMessage" class="confirmation-message">
                                <p><strong>¡Contrato creado exitosamente!</strong></p>
                                <p>ID del contrato: <span class="appointment-id" id="contractIdDisplay"></span></p>
                                <p>El contrato se ha guardado y está listo para imprimir o enviar por WhatsApp.</p>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 2rem;">
                                <button type="submit" class="btn" id="submitContractBtn" style="flex: 1;">Guardar Contrato</button>
                                <button type="button" class="btn cancel-btn" id="cancelContractBtn" style="flex: 1;">Cancelar</button>
                                <button type="button" class="btn print-btn" id="printContractBtn" style="flex: 1; display: none;">
                                    <i class="fas fa-print"></i> Imprimir Contrato
                                </button>
                                <button type="button" class="btn whatsapp" id="sendWhatsAppBtn" style="flex: 1; display: none;">
                                    <i class="fab fa-whatsapp"></i> MANDAR POR WHATSAPP
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Columna derecha: Vista previa del contrato -->
                    <div class="sidebar-column">
                        <div class="contract-preview-container">
                            <h3><i class="fas fa-file-contract"></i> Vista Previa del Contrato</h3>
                            <div class="contract-preview" id="contractPreview">
                                <!-- La vista previa se generará dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sección de Ver Contratos (SOLO CONTRATOS) -->
            <div class="admin-section" id="viewContractsSection">
                <div class="section-title">
                    <h2>Contratos Registrados</h2>
                    <p>Busca y gestiona todos los contratos de eventos</p>
                </div>
                
                <!-- Filtros de búsqueda avanzada -->
                <div class="advanced-filters">
                    <h4><i class="fas fa-filter"></i> Filtros de Búsqueda</h4>
                    <div class="filter-row">
                        <div class="form-group">
                            <label for="searchContractor">Buscar por Nombre o Teléfono</label>
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchContractor" placeholder="Nombre o número de teléfono">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="searchEventType">Tipo de Evento</label>
                            <select id="searchEventType">
                                <option value="all">Todos los tipos</option>
                                <option value="Boda">Boda</option>
                                <option value="Quinceañera">Quinceañera</option>
                                <option value="Cumpleaños">Cumpleaños</option>
                                <option value="Graduación">Graduación</option>
                                <option value="Bautizo">Bautizo</option>
                                <option value="Evento Corporativo">Evento Corporativo</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filterStatus">Estado</label>
                            <select id="filterStatus">
                                <option value="all">Todos</option>
                                <option value="pendiente">Pendiente</option>
                                <option value="confirmado">Confirmado</option>
                                <option value="completado">Completado</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filterDateRange">Rango de Fechas</label>
                            <input type="month" id="filterDateRange">
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="action-btn" id="applySearchBtn">
                            <i class="fas fa-filter"></i> Aplicar Filtros
                        </button>
                        <button type="button" class="action-btn info" id="clearSearchBtn">
                            <i class="fas fa-eraser"></i> Limpiar Filtros
                        </button>
                    </div>
                </div>

                <!-- BUSCADOR RÁPIDO MEJORADO -->
                <div class="quick-search">
                    <i class="fas fa-search"></i>
                    <input type="text" id="quickSearch" placeholder="Buscar por nombre, teléfono o evento (escribe para buscar en tiempo real)">
                </div>
                
                <!-- Tabla de contratos -->
                <div class="section-content">
                    <h3><i class="fas fa-file-contract"></i> Lista de Contratos</h3>
                    <div class="contracts-table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Contratante</th>
                                    <th>Teléfono</th>
                                    <th>Evento</th>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                    <th>Costo Base</th>
                                    <th>Total</th>
                                    <th>Pagado</th>
                                    <th>Saldo</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="contractsTable">
                                <!-- Los contratos se cargarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Sección de Estadísticas (SEPARADA) -->
            <div class="admin-section" id="statisticsSection">
                <div class="section-title">
                    <h2>Estadísticas</h2>
                    <p>Visualiza estadísticas de contratos completados e ingresos</p>
                </div>
                
                <!-- Panel de Estadísticas -->
                <div class="statistics-panel">
                    <h3><i class="fas fa-chart-line"></i> Panel de Estadísticas</h3>
                    
                    <div class="statistics-filters">
                        <div>
                            <label for="statsYear">Año:</label>
                            <select id="statsYear">
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div>
                            <label for="statsMonth">Mes:</label>
                            <select id="statsMonth">
                                <option value="all">Todos los meses</option>
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>
                        <div>
                            <label for="statsStatus">Estado:</label>
                            <select id="statsStatus">
                                <option value="completado" selected>Completado</option>
                                <option value="all">Todos</option>
                            </select>
                        </div>
                        <button type="button" class="action-btn" id="loadStatsBtn">
                            <i class="fas fa-sync-alt"></i> Actualizar Estadísticas
                        </button>
                    </div>
                    
                    <!-- Tarjetas de resumen -->
                    <div class="statistics-grid">
                        <div class="stat-card">
                            <h5>Contratos Totales</h5>
                            <div class="value" id="totalContracts">0</div>
                            <div class="change" id="contractsChange">--</div>
                        </div>
                        <div class="stat-card">
                            <h5>Ingresos Totales</h5>
                            <div class="value" id="totalRevenue">$0</div>
                            <div class="change" id="revenueChange">--</div>
                        </div>
                        <div class="stat-card">
                            <h5>Promedio por Contrato</h5>
                            <div class="value" id="averageContract">$0</div>
                            <div class="change" id="averageChange">--</div>
                        </div>
                        <div class="stat-card">
                            <h5>Eventos Completados</h5>
                            <div class="value" id="completedEvents">0</div>
                            <div class="change" id="completedChange">--</div>
                        </div>
                    </div>
                    
                    <!-- Gráficos -->
                    <div class="charts-container">
                        <div class="chart-card">
                            <h4><i class="fas fa-chart-bar"></i> Ingresos por Mes</h4>
                            <div class="chart-container">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h4><i class="fas fa-chart-pie"></i> Distribución por Estado</h4>
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabla de desglose mensual -->
                    <div class="monthly-breakdown">
                        <h4><i class="fas fa-table"></i> Desglose Mensual</h4>
                        <table id="monthlyBreakdown">
                            <thead>
                                <tr>
                                    <th>Mes</th>
                                    <th>Contratos</th>
                                    <th>Ingresos Totales</th>
                                    <th>Promedio por Evento</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyBreakdownBody">
                                <!-- Los datos mensuales se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Sección de Calendario - MEJORADA -->
            <div class="admin-section" id="calendarSection">
                <div class="section-title">
                    <h2>Calendario de Eventos</h2>
                    <p>Visualiza todos los eventos programados en el calendario - Haz clic en un evento para editarlo o eliminarlo</p>
                </div>
                <div class="section-content">
                    <div class="calendar-container">
                        <h3><i class="fas fa-calendar-alt"></i> Calendario del Salón Azul</h3>
                        <div id="calendar"></div>
                    </div>
                </div>
            </div>
            
            <!-- Sección de Inventario -->
            <div class="admin-section" id="inventorySection">
                <div class="section-title">
                    <h2>Gestión de Inventario</h2>
                    <p>Administra el inventario de mobiliario y accesorios del salón</p>
                </div>
                
                <div class="inventory-summary">
                    <div class="summary-card">
                        <h3><i class="fas fa-warehouse"></i> Total de Artículos</h3>
                        <div class="summary-value" id="totalItems">0</div>
                        <p>Artículos en inventario</p>
                    </div>
                    <div class="summary-card">
                        <h3><i class="fas fa-exclamation-triangle"></i> Bajo Stock</h3>
                        <div class="summary-value low-stock" id="lowStockItems">0</div>
                        <p>Artículos con stock crítico</p>
                    </div>
                    <div class="summary-card">
                        <h3><i class="fas fa-table"></i> Mesas</h3>
                        <div class="summary-value" id="totalTables">0</div>
                        <p>Mesas disponibles</p>
                    </div>
                    <div class="summary-card">
                        <h3><i class="fas fa-tshirt"></i> Manteles</h3>
                        <div class="summary-value" id="totalTablecloths">0</div>
                        <p>Manteles disponibles</p>
                    </div>
                </div>
                
                <div class="section-content">
                    <h3><i class="fas fa-boxes"></i> Inventario Actual</h3>
                    <div class="inventory-grid" id="inventoryGrid">
                        <!-- Los artículos de inventario se cargarán aquí dinámicamente -->
                    </div>
                    
                    <div class="inventory-form">
                        <h3><i class="fas fa-plus-circle"></i> Agregar/Editar Artículo</h3>
                        <form id="inventoryForm">
                            <input type="hidden" id="inventoryItemId" value="">
                            <input type="hidden" id="isEditingInventory" value="false">
                            
                            <div class="inventory-form-columns">
                                <div>
                                    <div class="form-group">
                                        <label for="itemName">Nombre del Artículo *</label>
                                        <input type="text" id="itemName" placeholder="Ej: Mesa redonda grande" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="itemCategory">Categoría *</label>
                                        <select id="itemCategory" required>
                                            <option value="">Selecciona una categoría</option>
                                            <option value="mesa_redonda">Mesa Redonda</option>
                                            <option value="mesa_rectangular">Mesa Rectangular</option>
                                            <option value="mantel">Mantel</option>
                                            <option value="silla">Silla</option>
                                            <option value="cubremantel">Cubremantel</option>
                                            <option value="decoracion">Decoración</option>
                                            <option value="utensilio">Utensilio</option>
                                            <option value="otros">Otros</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="itemQuantity">Cantidad *</label>
                                        <input type="number" id="itemQuantity" min="0" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="itemMinQuantity">Cantidad Mínima *</label>
                                        <input type="number" id="itemMinQuantity" min="0" required>
                                        <small style="color: #666;">Se alertará cuando el stock esté por debajo de este número</small>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="form-group">
                                        <label for="itemDescription">Descripción</label>
                                        <textarea id="itemDescription" rows="3" placeholder="Descripción del artículo"></textarea>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="itemLocation">Ubicación</label>
                                        <input type="text" id="itemLocation" placeholder="Ej: Almacén principal, Estante 3">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="itemCondition">Estado</label>
                                        <select id="itemCondition">
                                            <option value="excelente">Excelente</option>
                                            <option value="bueno">Bueno</option>
                                            <option value="regular">Regular</option>
                                            <option value="necesita_reparacion">Necesita Reparación</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="itemNotes">Notas Adicionales</label>
                                        <textarea id="itemNotes" rows="2" placeholder="Notas adicionales sobre el artículo"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                                <button type="submit" class="btn" id="saveInventoryBtn">
                                    <i class="fas fa-save"></i> Guardar Artículo
                                </button>
                                <button type="button" class="btn cancel-btn" id="cancelInventoryBtn">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles de contrato desde calendario -->
    <div id="calendarEventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Detalles del Evento</h3>
                <button class="close-modal" id="closeCalendarModal">&times;</button>
            </div>
            <div id="calendarEventContent">
                <!-- Los detalles del evento se cargarán aquí -->
            </div>
            <div class="calendar-actions" id="calendarEventActions">
                <!-- Las acciones se cargarán aquí -->
            </div>
        </div>
    </div>

    <!-- Modal para conflicto de fechas -->
    <div id="dateConflictModal" class="modal conflict-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Fecha Ocupada</h3>
                <button class="close-modal" id="closeDateConflictModal">&times;</button>
            </div>
            <div id="dateConflictContent">
                <p>La fecha seleccionada <strong id="conflictDate"></strong> ya está ocupada por el siguiente contrato:</p>
                <div id="conflictContractDetails" class="conflict-details">
                    <!-- Los detalles del contrato conflictivo se cargarán aquí -->
                </div>
                <p>¿Desea continuar con el nuevo contrato en esta fecha?</p>
            </div>
            <div class="conflict-actions">
                <button class="btn warning" id="confirmSaveWithConflict">Continuar de todos modos</button>
                <button class="btn cancel-btn" id="cancelSaveWithConflict">Cancelar y cambiar fecha</button>
            </div>
        </div>
    </div>

    <!-- Modal para abonar a un contrato -->
    <div id="paymentModal" class="modal payment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-money-bill-wave"></i> Agregar Pago al Contrato</h3>
                <button class="close-modal" id="closePaymentModal">&times;</button>
            </div>
            <div id="paymentModalContent">
                <div class="contract-summary">
                    <h4>Resumen del Contrato</h4>
                    <p><strong>Contratante:</strong> <span id="paymentContractorName"></span></p>
                    <p><strong>Evento:</strong> <span id="paymentEventType"></span> - <span id="paymentEventDate"></span></p>
                    <p><strong>Total del Contrato:</strong> $<span id="paymentTotalAmount">0</span></p>
                    <p><strong>Pagado hasta ahora:</strong> $<span id="paymentPaidSoFar">0</span></p>
                    <p><strong>Saldo Pendiente:</strong> $<span id="paymentRemainingBalance">0</span></p>
                </div>
                
                <form id="addPaymentForm">
                    <input type="hidden" id="paymentContractId" value="">
                    
                    <div class="form-group">
                        <label for="paymentAmount">Monto a Abonar *</label>
                        <input type="number" id="paymentAmount" placeholder="Ingrese el monto a abonar" min="1" required>
                        <small style="color: #666;">Saldo máximo a abonar: $<span id="paymentMaxAmount">0</span></small>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentDate">Fecha del Pago *</label>
                        <input type="date" id="paymentDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentMethodModal">Método de Pago *</label>
                        <select id="paymentMethodModal" required>
                            <option value="">Seleccione método de pago</option>
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Depósito">Depósito</option>
                            <option value="Tarjeta de Crédito">Tarjeta de Crédito</option>
                            <option value="Tarjeta de Débito">Tarjeta de Débito</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentNotes">Notas (Opcional)</label>
                        <textarea id="paymentNotes" rows="2" placeholder="Notas adicionales sobre el pago"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="submit" class="btn success" style="flex: 1;">
                            <i class="fas fa-check-circle"></i> Confirmar Pago
                        </button>
                        <button type="button" class="btn cancel-btn" id="cancelPaymentBtn" style="flex: 1;">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para vista previa completa del contrato -->
    <div id="fullContractModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-file-contract"></i> Vista Previa Completa del Contrato</h3>
                <button class="close-modal" id="closeFullContractModal">&times;</button>
            </div>
            <div class="full-contract-view" id="fullContractContent">
                <!-- El contrato completo se cargará aquí -->
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem; justify-content: flex-end;">
                <button class="btn print-btn" id="printFullContractBtn">
                    <i class="fas fa-print"></i> IMPRIMIR CONTRATO
                </button>
                <button class="btn" id="closeFullContractBtn">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Aviso para adjuntar PDF a WhatsApp -->
    <div id="pdfNotification" class="pdf-notification">
        <div class="pdf-notification-header">
            <i class="fas fa-file-pdf"></i>
            <h4>PDF Generado para WhatsApp</h4>
        </div>
        <div class="pdf-notification-body">
            <p>El PDF del contrato se ha descargado exitosamente.</p>
            <p><strong>Ahora se abrirá WhatsApp Web en una nueva pestaña.</strong></p>
            <p><strong>Por favor, adjunta este archivo al chat del contratante:</strong></p>
            <p><strong>Contratante:</strong> <span id="pdfContractorName"></span></p>
            <p><strong>Teléfono:</strong> <span id="pdfContractorPhone"></span></p>
            <p><strong>Archivo:</strong> <span id="pdfFileName"></span></p>
        </div>
        <div class="pdf-notification-actions">
            <button class="btn whatsapp" id="openWhatsAppBtn">
                <i class="fab fa-whatsapp"></i> Abrir WhatsApp Web
            </button>
            <button class="btn" id="closePdfNotificationBtn">
                <i class="fas fa-times"></i> Cerrar
            </button>
        </div>
    </div>

    <!-- Contrato para generar PDF (oculto) -->
    <div id="pdfContract" style="position: absolute; left: -9999px; top: -9999px; width: 210mm; background: white; padding: 20mm; font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 1.6;">
        <!-- El contrato para PDF se generará aquí -->
    </div>

    <!-- Notificación -->
    <div id="notification" class="notification">
        <div class="notification-icon"></div>
        <div class="notification-content"></div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-container">
                <div class="footer-info">
                    <h3>Salón Azul</h3>
                    <p>Sistema de gestión de contratos e inventario para salón de fiestas</p>
                </div>
                <div class="footer-contact">
                    <h4>Contacto</h4>
                    <p><i class="fas fa-phone"></i> +52 55 31326093</p>
                    <p><i class="fas fa-map-marker-alt"></i> Calle Sucesos Nacionales No. 329, Colonia Prensa Nacional, Tlalnepantla de Baz, C.P. 54170, Estado de México</p>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2025 Salón Azul - Todos los derechos reservados</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js"></script>
    <script>
        // Variables globales
        let contracts = JSON.parse(localStorage.getItem('salonAzulContracts')) || [];
        let inventory = JSON.parse(localStorage.getItem('salonAzulInventory')) || [];
        let signatureContractor = null;
        let signatureRepresentative = null;
        let lastCreatedContractId = null;
        let isEditMode = false;
        let currentContractId = null;
        let additionalPayments = [];
        let currentInventoryItemId = null;
        let revenueChart = null;
        let statusChart = null;
        let calendarInstance = null;
        
        // ==============================================
        // SISTEMA DE LOGIN CORREGIDO Y SEGURO
        // ==============================================
        
        // Función segura para verificar credenciales
        function verifyCredentials(username, password) {
            // Lista de usuarios autorizados (en un sistema real esto estaría en el servidor)
            const authorizedUsers = {
                'hiram2009': 'Salonazul1960!'
            };
            
            return authorizedUsers[username] === password;
        }
        
        // Función de login segura
        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            // Validar campos
            if (!username || !password) {
                showNotification('Por favor, complete todos los campos', 'error');
                return;
            }
            
            // Verificar credenciales de forma segura
            if (verifyCredentials(username, password)) {
                // Mostrar información del usuario
                showUserInfo();
                
                // Esperar un momento y mostrar el panel
                setTimeout(() => {
                    initializeAdminPanel();
                    showPanel('adminPanel');
                    showNotification('Inicio de sesión exitoso', 'success');
                }, 500);
                
            } else {
                showNotification('Usuario o contraseña incorrectos', 'error');
                document.getElementById('userInfoBox').classList.remove('show');
                
                // Limpiar campo de contraseña
                document.getElementById('password').value = '';
                document.getElementById('password').focus();
            }
        }
        
        // Mostrar información del usuario
        function showUserInfo() {
            const userInfoBox = document.getElementById('userInfoBox');
            const userTypeText = document.getElementById('userTypeText');
            const userDescription = document.getElementById('userDescription');
            const userBadge = document.getElementById('userBadge');
            
            userTypeText.textContent = 'Administrador del Salón Azul';
            userDescription.textContent = 'Tendrás acceso completo al sistema para gestionar contratos, eventos e inventario.';
            userBadge.innerHTML = '<i class="fas fa-user-shield"></i> Administrador';
            
            userInfoBox.classList.add('show');
        }
        
        // ==============================================
        // FUNCIONES DEL SISTEMA
        // ==============================================
        
        // Mostrar notificación
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationIcon = notification.querySelector('.notification-icon');
            const notificationContent = notification.querySelector('.notification-content');
            
            notification.className = `notification ${type}`;
            
            if (type === 'success') {
                notificationIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                notificationContent.innerHTML = `<strong>Éxito:</strong> ${message}`;
            } else if (type === 'error') {
                notificationIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
                notificationContent.innerHTML = `<strong>Error:</strong> ${message}`;
            } else {
                notificationIcon.innerHTML = '<i class="fas fa-info-circle"></i>';
                notificationContent.innerHTML = `<strong>Información:</strong> ${message}`;
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
        
        // Mostrar/ocultar paneles
        function showPanel(panelId) {
            // Ocultar todas las secciones
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('login').style.display = 'none';
            document.getElementById('inicio').style.display = 'none';
            document.querySelector('footer').style.display = 'none';
            
            // Mostrar la sección solicitada
            if (panelId === 'adminPanel') {
                document.getElementById('adminPanel').style.display = 'block';
                document.querySelector('footer').style.display = 'block';
                
                // Mostrar la sección activa
                const activeSection = document.querySelector('.admin-nav-btn.active');
                if (activeSection) {
                    const sectionId = activeSection.getAttribute('data-section') + 'Section';
                    document.getElementById(sectionId).classList.add('active');
                }
            } else {
                // Para otras secciones (login, inicio)
                if (document.getElementById(panelId)) {
                    document.getElementById(panelId).style.display = 'block';
                    document.querySelector('footer').style.display = 'block';
                }
            }
        }
        
        // Configurar evento de login
        document.getElementById('loginBtn').addEventListener('click', handleLogin);
        
        // Permitir login con Enter
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });
        
        // Cerrar sesión
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('¿Está seguro de que desea cerrar sesión?')) {
                location.reload();
            }
        });
        
        // ==============================================
        // INICIALIZACIÓN DEL SISTEMA
        // ==============================================
        
        // Inicializar inventario con datos por defecto si está vacío
        function initializeDefaultInventory() {
            if (inventory.length === 0) {
                const defaultInventory = [
                    {
                        id: 1,
                        name: "Mesa redonda grande",
                        category: "mesa_redonda",
                        quantity: 25,
                        minQuantity: 5,
                        description: "Mesas redondas para 10 personas",
                        location: "Almacén principal",
                        condition: "bueno",
                        notes: "Algunas con pequeños arañazos",
                        lastUpdated: new Date().toISOString().split('T')[0]
                    },
                    {
                        id: 2,
                        name: "Mesa rectangular",
                        category: "mesa_rectangular",
                        quantity: 15,
                        minQuantity: 3,
                        description: "Mesas rectangulares para buffet",
                        location: "Almacén lateral",
                        condition: "excelente",
                        notes: "Nuevas, adquiridas este año",
                        lastUpdated: new Date().toISOString().split('T')[0]
                    },
                    {
                        id: 3,
                        name: "Mantel blanco",
                        category: "mantel",
                        quantity: 50,
                        minQuantity: 10,
                        description: "Manteles blancos para mesas redondas",
                        location: "Estante 2, Almacén",
                        condition: "bueno",
                        notes: "Algunos necesitan lavado profesional",
                        lastUpdated: new Date().toISOString().split('T')[0]
                    },
                    {
                        id: 4,
                        name: "Mantel rojo",
                        category: "mantel",
                        quantity: 30,
                        minQuantity: 8,
                        description: "Manteles rojos para eventos especiales",
                        location: "Estante 3, Almacén",
                        condition: "excelente",
                        notes: "Poco uso",
                        lastUpdated: new Date().toISOString().split('T')[0]
                    },
                    {
                        id: 5,
                        name: "Cubremantel transparente",
                        category: "cubremantel",
                        quantity: 40,
                        minQuantity: 15,
                        description: "Cubremanteles protectores transparentes",
                        location: "Caja 5, Almacén",
                        condition: "regular",
                        notes: "Algunos desgastados, considerar reemplazo",
                        lastUpdated: new Date().toISOString().split('T')[0]
                    },
                    {
                        id: 6,
                        name: "Silla de banquet",
                        category: "silla",
                        quantity: 250,
                        minQuantity: 50,
                        description: "Sillas para invitados",
                        location: "Sala de eventos",
                        condition: "bueno",
                        notes: "20 sillas necesitan reparación",
                        lastUpdated: new Date().toISOString().split('T')[0]
                    }
                ];
                
                inventory = defaultInventory;
                saveInventoryData();
            }
        }
        
        // Generar datos de ejemplo para contratos si no hay
        function generateSampleContracts() {
            if (contracts.length === 0) {
                const sampleContracts = [
                    {
                        id: 1001,
                        contractorName: "María González",
                        contractorPhone: "5551234567",
                        contractorAddress: "Calle Principal 123, Ciudad de México",
                        celebrantName: "Ana González",
                        contractDay: "15",
                        contractMonth: "Marzo",
                        contractYear: "2025",
                        representativeName: "Representante de Salón Azul",
                        eventType: "Quinceañera",
                        eventDate: "2025-06-15",
                        guestsNumber: 150,
                        startTime: "15:00",
                        endTime: "20:00",
                        baseCost: 15000,
                        extraHourCost: 500,
                        additionalServices: "Fotógrafo, Video, Pantalla",
                        tablecloth: "Sí",
                        tableclothColor: "Blanco",
                        totalAmount: 18000,
                        advancePayment: 9000,
                        balanceDue: 9000,
                        paymentMethod: "Efectivo",
                        alcoholExtraCost: 200,
                        extraGuestCost: 450,
                        signatureContractor: null,
                        signatureRepresentative: null,
                        additionalPayments: [],
                        totalPaid: 9000,
                        status: "confirmado",
                        createdAt: "2025-03-10"
                    },
                    {
                        id: 1002,
                        contractorName: "Carlos Rodríguez",
                        contractorPhone: "5559876543",
                        contractorAddress: "Avenida Central 456, Tlalnepantla",
                        celebrantName: "Luis Rodríguez",
                        contractDay: "20",
                        contractMonth: "Marzo",
                        contractYear: "2025",
                        representativeName: "Representante de Salón Azul",
                        eventType: "Cumpleaños",
                        eventDate: "2025-05-20",
                        guestsNumber: 80,
                        startTime: "14:00",
                        endTime: "19:00",
                        baseCost: 8000,
                        extraHourCost: 500,
                        additionalServices: "DJ, Decoración especial",
                        tablecloth: "No",
                        tableclothColor: "",
                        totalAmount: 9500,
                        advancePayment: 4750,
                        balanceDue: 4750,
                        paymentMethod: "Transferencia",
                        alcoholExtraCost: 200,
                        extraGuestCost: 450,
                        signatureContractor: null,
                        signatureRepresentative: null,
                        additionalPayments: [
                            { id: 1, date: "2025-04-10", amount: 2000, method: "Efectivo", addedAt: "2025-04-10T10:30:00" }
                        ],
                        totalPaid: 6750,
                        status: "pendiente",
                        createdAt: "2025-03-05"
                    },
                    {
                        id: 1003,
                        contractorName: "Laura Martínez",
                        contractorPhone: "5554567890",
                        contractorAddress: "Calle Secundaria 789, Estado de México",
                        celebrantName: "Pedro Martínez",
                        contractDay: "5",
                        contractMonth: "Abril",
                        contractYear: "2025",
                        representativeName: "Representante de Salón Azul",
                        eventType: "Boda",
                        eventDate: "2025-08-10",
                        guestsNumber: 200,
                        startTime: "16:00",
                        endTime: "21:00",
                        baseCost: 25000,
                        extraHourCost: 500,
                        additionalServices: "Fotógrafo, Video, Pantalla, DJ, Decoración floral",
                        tablecloth: "Sí",
                        tableclothColor: "Rojo",
                        totalAmount: 30000,
                        advancePayment: 15000,
                        balanceDue: 15000,
                        paymentMethod: "Tarjeta de Crédito",
                        alcoholExtraCost: 200,
                        extraGuestCost: 450,
                        signatureContractor: null,
                        signatureRepresentative: null,
                        additionalPayments: [
                            { id: 1, date: "2025-04-15", amount: 5000, method: "Transferencia", addedAt: "2025-04-15T14:20:00" }
                        ],
                        totalPaid: 20000,
                        status: "completado",
                        createdAt: "2025-03-01"
                    },
                    {
                        id: 1004,
                        contractorName: "Javier Pérez",
                        contractorPhone: "5557890123",
                        contractorAddress: "Boulevard Norte 321, Tlalnepantla",
                        celebrantName: "Sofía Pérez",
                        contractDay: "12",
                        contractMonth: "Abril",
                        contractYear: "2025",
                        representativeName: "Representante de Salón Azul",
                        eventType: "Graduación",
                        eventDate: "2025-07-05",
                        guestsNumber: 100,
                        startTime: "13:00",
                        endTime: "18:00",
                        baseCost: 12000,
                        extraHourCost: 500,
                        additionalServices: "DJ, Pantalla",
                        tablecloth: "No",
                        tableclothColor: "",
                        totalAmount: 13500,
                        advancePayment: 6750,
                        balanceDue: 6750,
                        paymentMethod: "Efectivo",
                        alcoholExtraCost: 200,
                        extraGuestCost: 450,
                        signatureContractor: null,
                        signatureRepresentative: null,
                        additionalPayments: [],
                        totalPaid: 6750,
                        status: "cancelado",
                        createdAt: "2025-03-15"
                    }
                ];
                
                contracts = sampleContracts;
                saveData();
            }
        }
        
        // Guardar datos en localStorage
        function saveData() {
            localStorage.setItem('salonAzulContracts', JSON.stringify(contracts));
            
            // Actualizar calendario si está activo
            if (calendarInstance) {
                setTimeout(() => {
                    initializeCalendar();
                }, 100);
            }
        }
        
        // Guardar inventario en localStorage
        function saveInventoryData() {
            localStorage.setItem('salonAzulInventory', JSON.stringify(inventory));
        }
        
        // Inicializar panel de administración
        function initializeAdminPanel() {
            // Establecer fecha actual
            const today = new Date();
            if (document.getElementById('contractDay')) {
                document.getElementById('contractDay').value = today.getDate();
                
                const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                document.getElementById('contractMonth').value = months[today.getMonth()];
                
                // Establecer fecha mínima para evento
                document.getElementById('eventDate').setAttribute('min', today.toISOString().split('T')[0]);
                document.getElementById('eventDate').value = today.toISOString().split('T')[0];
                
                // Establecer hora por defecto
                document.getElementById('startTime').value = '15:00';
                document.getElementById('endTime').value = '20:00';
                
                // Establecer fecha de hoy para pagos
                document.getElementById('paymentDate').value = today.toISOString().split('T')[0];
                
                // Inicializar cálculos de pago
                initializePaymentCalculations();
                
                // Inicializar firmas digitales
                initializeSignaturePads();
                
                // Inicializar campos de cubremantel
                initializeTableclothFields();
                
                // Validación de hora de inicio
                initializeTimeValidation();
                
                // Generar vista previa inicial
                updateContractPreview();
                
                // Actualizar vista previa cuando cambien los campos
                setupPreviewUpdates();
                
                // Verificar disponibilidad de fechas
                setupDateValidation();
            }
            
            // Inicializar inventario por defecto
            initializeDefaultInventory();
            
            // Generar contratos de ejemplo si no hay
            generateSampleContracts();
            
            // Inicializar buscador rápido
            initializeQuickSearch();
            
            // Cargar datos iniciales
            loadContractsTable();
            loadStatistics();
        }
        
        // Inicializar buscador rápido
        function initializeQuickSearch() {
            const quickSearchInput = document.getElementById('quickSearch');
            
            quickSearchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                
                if (searchTerm.length === 0) {
                    loadContractsTable();
                } else {
                    performQuickSearch(searchTerm);
                }
            });
            
            quickSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const searchTerm = this.value.trim();
                    if (searchTerm.length > 0) {
                        performQuickSearch(searchTerm);
                    }
                }
            });
        }
        
        // Realizar búsqueda rápida
        function performQuickSearch(searchTerm) {
            const searchTermLower = searchTerm.toLowerCase();
            
            const filteredContracts = contracts.filter(contract => {
                if (contract.contractorName && contract.contractorName.toLowerCase().includes(searchTermLower)) {
                    return true;
                }
                
                if (contract.contractorPhone && contract.contractorPhone.includes(searchTerm)) {
                    return true;
                }
                
                if (contract.eventType && contract.eventType.toLowerCase().includes(searchTermLower)) {
                    return true;
                }
                
                if (contract.celebrantName && contract.celebrantName.toLowerCase().includes(searchTermLower)) {
                    return true;
                }
                
                if (contract.id && contract.id.toString().includes(searchTerm)) {
                    return true;
                }
                
                return false;
            });
            
            displaySearchResults(filteredContracts, searchTerm);
        }
        
        // Mostrar resultados de búsqueda
        function displaySearchResults(filteredContracts, searchTerm) {
            const table = document.getElementById('contractsTable');
            
            if (filteredContracts.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="12" class="no-results">
                            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            No se encontraron contratos que coincidan con "${searchTerm}"
                        </td>
                    </tr>`;
                return;
            }
            
            filteredContracts.sort((a, b) => new Date(b.eventDate || 0) - new Date(a.eventDate || 0));
            
            table.innerHTML = '';
            
            filteredContracts.forEach(contract => {
                const row = document.createElement('tr');
                row.className = 'contract-row';
                
                const totalPaid = contract.advancePayment + (contract.additionalPayments || []).reduce((sum, payment) => sum + payment.amount, 0);
                
                let formattedDate = contract.eventDate || 'No definida';
                if (contract.eventDate) {
                    const dateObj = new Date(contract.eventDate);
                    formattedDate = dateObj.toLocaleDateString('es-ES');
                }
                
                let statusClass = 'contract-status ';
                switch(contract.status) {
                    case 'pendiente': statusClass += 'pendiente'; break;
                    case 'confirmado': statusClass += 'confirmado'; break;
                    case 'completado': statusClass += 'completado'; break;
                    case 'cancelado': statusClass += 'cancelado'; break;
                    default: statusClass += 'pendiente';
                }
                
                const highlightText = (text, column) => {
                    if (!searchTerm || !text) return text;
                    const searchLower = searchTerm.toLowerCase();
                    const textLower = text.toString().toLowerCase();
                    
                    if (column === 'phone') {
                        if (text.toString().includes(searchTerm)) {
                            const index = text.toString().indexOf(searchTerm);
                            const before = text.toString().substring(0, index);
                            const match = text.toString().substring(index, index + searchTerm.length);
                            const after = text.toString().substring(index + searchTerm.length);
                            return `${before}<span class="search-highlight">${match}</span>${after}`;
                        }
                    } else if (textLower.includes(searchLower)) {
                        const index = textLower.indexOf(searchLower);
                        const before = text.toString().substring(0, index);
                        const match = text.toString().substring(index, index + searchTerm.length);
                        const after = text.toString().substring(index + searchTerm.length);
                        return `${before}<span class="search-highlight">${match}</span>${after}`;
                    }
                    return text;
                };
                
                row.innerHTML = `
                    <td>${highlightText(contract.id.toString(), 'id')}</td>
                    <td>${highlightText(contract.contractorName, 'name')}</td>
                    <td>${highlightText(contract.contractorPhone, 'phone')}</td>
                    <td>${highlightText(contract.eventType, 'event')}</td>
                    <td>${formattedDate}</td>
                    <td>${contract.startTime || ''}</td>
                    <td>$${(contract.baseCost || 0).toLocaleString()}</td>
                    <td>$${(contract.totalAmount || 0).toLocaleString()}</td>
                    <td>$${totalPaid.toLocaleString()}</td>
                    <td>$${(contract.balanceDue || 0).toLocaleString()}</td>
                    <td><span class="${statusClass}">${contract.status || 'pendiente'}</span></td>
                    <td>
                        <button class="action-btn" onclick="viewFullContract(${contract.id})" title="Ver contrato completo">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn info" onclick="editContract(${contract.id})" title="Editar contrato">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn success" onclick="addPaymentToContract(${contract.id})" title="Agregar pago">
                            <i class="fas fa-money-bill-wave"></i>
                        </button>
                        <button class="action-btn whatsapp" onclick="sendContractViaWhatsApp(${contract.id})" title="Enviar contrato por WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <button class="action-btn warning" onclick="markAsCompleted(${contract.id})" title="Marcar como completado">
                            <i class="fas fa-check-circle"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteContract(${contract.id})" title="Eliminar contrato">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                table.appendChild(row);
            });
        }
        
        // Inicializar campos de cubremantel
        function initializeTableclothFields() {
            const tableclothSelect = document.getElementById('tablecloth');
            const tableclothColorGroup = document.getElementById('tableclothColorGroup');
            
            if (tableclothSelect) {
                tableclothSelect.addEventListener('change', function() {
                    if (this.value === 'Sí') {
                        tableclothColorGroup.style.display = 'block';
                    } else {
                        tableclothColorGroup.style.display = 'none';
                        document.getElementById('tableclothColor').value = '';
                    }
                    updateContractPreview();
                });
            }
        }
        
        // Inicializar validación de hora
        function initializeTimeValidation() {
            const startTimeInput = document.getElementById('startTime');
            
            if (startTimeInput) {
                startTimeInput.addEventListener('change', function() {
                    const startTime = this.value;
                    const maxTime = "18:00";
                    
                    if (startTime > maxTime) {
                        showNotification('La hora de inicio no puede ser después de las 6:00 PM (18:00)', 'error');
                        this.value = maxTime;
                    }
                    
                    const endTimeInput = document.getElementById('endTime');
                    const endTime = endTimeInput.value;
                    
                    if (endTime && startTime >= endTime) {
                        showNotification('La hora de término debe ser posterior a la hora de inicio', 'error');
                        endTimeInput.value = '';
                        endTimeInput.focus();
                    }
                });
            }
            
            const endTimeInput = document.getElementById('endTime');
            if (endTimeInput) {
                endTimeInput.addEventListener('change', function() {
                    const startTime = document.getElementById('startTime').value;
                    const endTime = this.value;
                    
                    if (startTime && endTime && startTime >= endTime) {
                        showNotification('La hora de término debe ser posterior a la hora de inicio', 'error');
                        this.value = '';
                        this.focus();
                    }
                });
            }
        }
        
        // Configurar validación de fechas
        function setupDateValidation() {
            const eventDateInput = document.getElementById('eventDate');
            if (eventDateInput) {
                eventDateInput.addEventListener('change', checkDateAvailability);
            }
        }
        
        // Verificar disponibilidad de fecha
        function checkDateAvailability() {
            const selectedDate = document.getElementById('eventDate').value;
            if (!selectedDate) return;
            
            const conflictingContracts = contracts.filter(contract => {
                if (isEditMode && contract.id === currentContractId) {
                    return false;
                }
                return contract.eventDate === selectedDate;
            });
            
            const dateWarning = document.getElementById('dateWarning');
            const dateAvailable = document.getElementById('dateAvailable');
            
            if (conflictingContracts.length > 0) {
                dateWarning.classList.add('show');
                dateAvailable.classList.remove('show');
                
                const conflict = conflictingContracts[0];
                dateWarning.innerHTML = `
                    <p><i class="fas fa-exclamation-triangle"></i> <strong>NO DISPONIBLE:</strong> La fecha ${selectedDate} ya está ocupada por el contrato #${conflict.id} (${conflict.contractorName} - ${conflict.eventType})</p>
                `;
            } else {
                dateWarning.classList.remove('show');
                dateAvailable.classList.add('show');
                dateAvailable.innerHTML = `
                    <p><i class="fas fa-check-circle"></i> <strong>DISPONIBLE:</strong> La fecha ${selectedDate} está disponible para el evento.</p>
                `;
            }
            
            updateContractPreview();
        }
        
        // Mostrar modal de conflicto de fecha
        function showDateConflictModal(conflictingContract, selectedDate) {
            document.getElementById('conflictDate').textContent = selectedDate;
            
            const conflictDetails = document.getElementById('conflictContractDetails');
            conflictDetails.innerHTML = `
                <p><strong>Contrato #${conflictingContract.id}</strong></p>
                <p><strong>Contratante:</strong> ${conflictingContract.contractorName}</p>
                <p><strong>Teléfono:</strong> ${conflictingContract.contractorPhone}</p>
                <p><strong>Evento:</strong> ${conflictingContract.eventType}</p>
                <p><strong>Hora:</strong> ${conflictingContract.startTime} - ${conflictingContract.endTime}</p>
                <p><strong>Costo Base:</strong> $${conflictingContract.baseCost.toLocaleString()}</p>
                <p><strong>Estado:</strong> <span class="status-badge ${getStatusClass(conflictingContract.status)}">${conflictingContract.status}</span></p>
            `;
            
            document.getElementById('dateConflictModal').style.display = 'flex';
        }
        
        // Obtener clase CSS para estado
        function getStatusClass(status) {
            switch(status) {
                case 'confirmado': return 'contract-status confirmado';
                case 'completado': return 'contract-status completado';
                case 'cancelado': return 'contract-status cancelado';
                default: return 'contract-status pendiente';
            }
        }
        
        // Inicializar cálculos de pago
        function initializePaymentCalculations() {
            const advancePaymentInput = document.getElementById('advancePayment');
            const totalAmountInput = document.getElementById('totalAmount');
            const baseCostInput = document.getElementById('baseCost');
            
            if (advancePaymentInput) {
                advancePaymentInput.addEventListener('input', function() {
                    const total = parseFloat(document.getElementById('totalAmount').value) || 0;
                    const advance = parseFloat(this.value) || 0;
                    const balance = Math.max(0, total - advance);
                    
                    document.getElementById('balanceDue').value = balance;
                    updatePaymentDisplay();
                    updateContractPreview();
                });
            }
            
            if (totalAmountInput) {
                totalAmountInput.addEventListener('input', function() {
                    const total = parseFloat(this.value) || 0;
                    const advance = parseFloat(document.getElementById('advancePayment').value) || 0;
                    const balance = Math.max(0, total - advance);
                    
                    document.getElementById('balanceDue').value = balance;
                    updatePaymentDisplay();
                    updateContractPreview();
                });
            }
            
            if (baseCostInput) {
                baseCostInput.addEventListener('input', function() {
                    const baseCost = parseFloat(this.value) || 0;
                    document.getElementById('totalAmount').value = baseCost;
                    updatePaymentDisplay();
                    updateContractPreview();
                });
            }
        }
        
        // Actualizar display de pagos
        function updatePaymentDisplay() {
            const baseCost = parseFloat(document.getElementById('baseCost').value) || 0;
            const extraHourCost = parseFloat(document.getElementById('extraHourCost').value) || 0;
            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            const advancePayment = parseFloat(document.getElementById('advancePayment').value) || 0;
            const balanceDue = parseFloat(document.getElementById('balanceDue').value) || 0;
            
            document.getElementById('displayBaseCost').textContent = `$${baseCost.toLocaleString()}`;
            document.getElementById('displayExtraHourCost').textContent = `$${extraHourCost.toLocaleString()}/hora`;
            document.getElementById('displayTotal').textContent = `$${totalAmount.toLocaleString()}`;
            document.getElementById('displayAdvance').textContent = `$${advancePayment.toLocaleString()}`;
            document.getElementById('displayBalance').textContent = `$${balanceDue.toLocaleString()}`;
        }
        
        // Inicializar pads de firma
        function initializeSignaturePads() {
            initializeSignaturePad('signaturePadContractor', 'signaturePreviewContractor', 'contractor');
            initializeSignaturePad('signaturePadRepresentative', 'signaturePreviewRepresentative', 'representative');
        }
        
        // Inicializar un pad de firma específico
        function initializeSignaturePad(canvasId, previewId, type) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });
            
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });
            
            canvas.addEventListener('touchend', function(e) {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup', {});
                canvas.dispatchEvent(mouseEvent);
            });
            
            function startDrawing(e) {
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function draw(e) {
                if (!isDrawing) return;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
                
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function stopDrawing() {
                isDrawing = false;
            }
            
            if (type === 'contractor') {
                document.getElementById('clearSignatureContractor').addEventListener('click', function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    signatureContractor = null;
                    document.getElementById(previewId).innerHTML = '<p style="color: #666; font-style: italic;">Aún no se ha guardado ninguna firma</p>';
                    showNotification('Firma del contratante limpiada', 'info');
                });
                
                document.getElementById('saveSignatureContractor').addEventListener('click', function() {
                    signatureContractor = canvas.toDataURL('image/png');
                    document.getElementById(previewId).innerHTML = `<img src="${signatureContractor}" alt="Firma del contratante">`;
                    showNotification('Firma del contratante guardada correctamente', 'success');
                });
            } else if (type === 'representative') {
                document.getElementById('clearSignatureRepresentative').addEventListener('click', function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    signatureRepresentative = null;
                    document.getElementById(previewId).innerHTML = '<p style="color: #666; font-style: italic;">Aún no se ha guardado ninguna firma</p>';
                    showNotification('Firma del representante limpiada', 'info');
                });
                
                document.getElementById('saveSignatureRepresentative').addEventListener('click', function() {
                    signatureRepresentative = canvas.toDataURL('image/png');
                    document.getElementById(previewId).innerHTML = `<img src="${signatureRepresentative}" alt="Firma del representante">`;
                    showNotification('Firma del representante guardada correctamente', 'success');
                });
            }
        }
        
        // Configurar actualizaciones de vista previa
        function setupPreviewUpdates() {
            const fields = [
                'contractorName', 'contractorPhone', 'contractorAddress', 'celebrantName',
                'contractDay', 'contractMonth', 'contractYear', 'representativeName',
                'eventType', 'eventDate', 'guestsNumber', 'startTime', 'endTime',
                'baseCost', 'extraHourCost', 'totalAmount', 'advancePayment', 'balanceDue', 'paymentMethod', 
                'alcoholExtraCost', 'extraGuestCost', 'additionalServices',
                'tablecloth', 'tableclothColor'
            ];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateContractPreview);
                }
            });
            
            const selects = ['eventType', 'paymentMethod', 'tablecloth'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.addEventListener('change', updateContractPreview);
                }
            });
        }
        
        // Generar vista previa del contrato
        function updateContractPreview() {
            const preview = document.getElementById('contractPreview');
            if (!preview) return;
            
            const contractorName = document.getElementById('contractorName')?.value || '________________';
            const contractorPhone = document.getElementById('contractorPhone')?.value || '________________';
            const contractorAddress = document.getElementById('contractorAddress')?.value || '________________';
            const celebrantName = document.getElementById('celebrantName')?.value || '________________';
            const contractDay = document.getElementById('contractDay')?.value || '______';
            const contractMonth = document.getElementById('contractMonth')?.value || '________________';
            const contractYear = document.getElementById('contractYear')?.value || '2025';
            const representativeName = document.getElementById('representativeName')?.value || '________________';
            const eventType = document.getElementById('eventType')?.value || '________________';
            const eventDate = document.getElementById('eventDate')?.value || '________________';
            const guestsNumber = document.getElementById('guestsNumber')?.value || '______';
            const startTime = document.getElementById('startTime')?.value || '__________';
            const endTime = document.getElementById('endTime')?.value || '__________';
            const baseCost = parseFloat(document.getElementById('baseCost')?.value) || 0;
            const extraHourCost = parseFloat(document.getElementById('extraHourCost')?.value) || 0;
            const totalAmount = parseFloat(document.getElementById('totalAmount')?.value) || 0;
            const advancePayment = parseFloat(document.getElementById('advancePayment')?.value) || 0;
            const balanceDue = parseFloat(document.getElementById('balanceDue')?.value) || 0;
            const paymentMethod = document.getElementById('paymentMethod')?.value || '________________';
            const alcoholExtraCost = parseFloat(document.getElementById('alcoholExtraCost')?.value) || 0;
            const extraGuestCost = parseFloat(document.getElementById('extraGuestCost')?.value) || 0;
            const additionalServices = document.getElementById('additionalServices')?.value || 'Ninguno';
            const tablecloth = document.getElementById('tablecloth')?.value || 'No';
            const tableclothColor = document.getElementById('tableclothColor')?.value || '';
            
            const totalPaid = advancePayment + additionalPayments.reduce((sum, payment) => sum + payment.amount, 0);
            
            let formattedEventDate = '________________';
            if (eventDate && eventDate !== '________________') {
                const dateObj = new Date(eventDate);
                formattedEventDate = dateObj.toLocaleDateString('es-ES', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
            }
            
            let availabilityInfo = '';
            if (document.getElementById('dateWarning')?.classList.contains('show')) {
                availabilityInfo = '<p style="color: #dc3545; background: #f8d7da; padding: 10px; border-radius: 5px; border-left: 4px solid #dc3545;"><i class="fas fa-exclamation-triangle"></i> <strong>FECHA NO DISPONIBLE</strong> - Esta fecha ya está ocupada por otro contrato.</p>';
            } else if (eventDate && eventDate !== '________________') {
                availabilityInfo = '<p style="color: #28a745; background: #d4edda; padding: 10px; border-radius: 5px; border-left: 4px solid #28a745;"><i class="fas fa-check-circle"></i> <strong>FECHA DISPONIBLE</strong></p>';
            }
            
            let tableclothInfo = '';
            if (tablecloth === 'Sí') {
                tableclothInfo = `<p><strong>Cubremantel:</strong> Sí${tableclothColor ? `, Color: ${tableclothColor}` : ''}</p>`;
            } else {
                tableclothInfo = '<p><strong>Cubremantel:</strong> No</p>';
            }
            
            const contractHTML = `
                <div class="contract-header">
                    <h1>SALÓN AZUL</h1>
                    <h2>CONTRATO PRIVADO DE PRESTACIÓN DE SERVICIOS PARA EVENTO SOCIAL</h2>
                    <p>El presente contrato establece las condiciones y cláusulas bajo las cuales se llevará a cabo un evento social en las instalaciones del SALÓN AZUL, mismo que ambas partes se obligan a cumplir.</p>
                </div>
                
                ${availabilityInfo}
                
                <div class="section">
                    <p>Este contrato se celebra entre:</p>
                    <p><strong>EL PRESTADOR DEL SERVICIO:</strong><br>
                    SALÓN AZUL, representado por: ${representativeName}</p>
                    
                    <p><strong>EL CONTRATANTE:</strong><br>
                    ${contractorName}</p>
                    
                    <p>A los <strong>${contractDay}</strong> días del mes de <strong>${contractMonth}</strong> del año <strong>${contractYear}</strong>, en el domicilio ubicado en Calle Sucesos Nacionales No. 329, Colonia Prensa Nacional, Tlalnepantla de Baz, C.P. 54170, Estado de México, domicilio oficial del Salón Azul.<br>
                    Registro del salón: 531 1422/2013.</p>
                </div>
                
                <div class="section">
                    <h3>I. CLÁUSULAS GENERALES</h3>
                    
                    <div class="contract-clause">
                        <h4><i class="fas fa-file-invoice-dollar"></i> Pago total obligatorio.</h4>
                        <p>El contratante se obliga a liquidar el total del arrendamiento con un mínimo de 15 días naturales antes de la fecha del evento. En caso de incumplimiento, el salón se reserva el derecho de cancelar el evento sin reembolso.</p>
                    </div>
                    
                    <div class="contract-clause">
                        <h4><i class="fas fa-hand-sparkles"></i> Medidas sanitarias (en caso de contingencia).</h4>
                        <p>En caso de contingencia sanitaria decretada por autoridad competente (ej. COVID u otra), no se permitirá el ingreso de grupos musicales, y será obligatorio el uso de cubrebocas, gel antibacterial y toma de temperatura, sin excepción.</p>
                    </div>
                    
                    <div class="contract-clause">
                        <h4><i class="fas fa-suitcase"></i> Objetos personales.</h4>
                        <p>El Salón Azul no se hace responsable por pérdida, robo u olvido de objetos personales dentro o fuera de las instalaciones.</p>
                    </div>
                    
                    <div class="contract-clause">
                        <h4><i class="fas fa-car-crash"></i> Accidentes.</h4>
                        <p>El Salón Azul no se hace responsable por accidentes, lesiones o incidentes ocurridos dentro o fuera del inmueble durante el evento.</p>
                    </div>
                    
                    <div class="contract-clause">
                        <h4><i class="fas fa-user-shield"></i> Conducta y seguridad.</h4>
                        <p>En caso de riñas, enfrentamientos, agresiones verbales o físicas entre invitados, o hacia el personal del salón, el evento será suspendido de inmediato sin derecho a reembolso.</p>
                    </div>
                    
                    <div class="contract-clause">
                        <h4><i class="fas fa-child"></i> Menores de edad.</h4>
                        <p>Los padres o tutores son totalmente responsables de la supervisión y seguridad de los menores durante todo el evento.</p>
                    </div>
                    
                    <div class="contract-clause">
                        <h4><i class="fas fa-gamepad"></i> Uso de juegos.</h4>
                        <p>Queda estrictamente prohibido que niños mayores de 8 años utilicen el carrusel u otros juegos no aptos para su edad.</p>
                    </div>
                    
                    <div class="contract-clause">
                        <h4><i class="fas fa-home"></i> Daños al inmueble.</h4>
                        <p>El contratante se obliga a pagar la reparación total de cualquier daño ocasionado al inmueble, mobiliario, decoración o equipo, independientemente de quién lo haya causado.</p>
                    </div>
                    
                    <div class="contract-clause">
                        <h4><i class="fas fa-chair"></i> Uso de mobiliario.</h4>
                        <p>Queda prohibido pararse, brincar, recostarse o hacer mal uso de sillas, mesas y mobiliario.</p>
                    </div>
                    
                    <div class="contract-clause">
                        <h4><i class="fas fa-user-tie"></i> Responsable del evento.</h4>
                        <p>El encargado o responsable del evento no podrá retirarse hasta que el evento concluya y todos los asistentes hayan desalojado el salón.</p>
                    </div>
                    
                    <div class="contract-clause">
                        <h4><i class="fas fa-wine-glass-alt"></i> Bebidas alcohólicas.</h4>
                        <p>No se permitirá ingresar más bebidas alcohólicas de las pactadas en el contrato.<br>
                        Por cada botella o cartón adicional se cobrará la cantidad de $<strong>${alcoholExtraCost.toLocaleString()}</strong>.</p>
                    </div>
                    
                    <div class="contract-clause">
                        <h4><i class="fas fa-clock"></i> Horas extras.</h4>
                        <p>Cualquier hora extra se cobrará a razón de $<strong>${extraHourCost.toLocaleString()}</strong> por hora.</p>
                    </div>
                    
                    <div class="contract-clause contract-prohibitions">
                        <h4><i class="fas fa-ban"></i> PROHIBICIONES ABSOLUTAS.</h4>
                        <p>Queda estrictamente prohibido:</p>
                        <ul>
                            <li>🚫 El uso de pirotecnia, chispas, bengalas, fuegos artificiales o similares</li>
                            <li>🚫 Fumar, vapear o consumir cigarros electrónicos dentro del salón</li>
                            <li>🚫 Ingerir bebidas alcohólicas fuera del inmueble</li>
                        </ul>
                    </div>
                    
                    <div class="contract-clause">
                        <h4><i class="fas fa-utensils"></i> Cocina y limpieza.</h4>
                        <p>La cocina deberá entregarse limpia y en orden.<br>
                        Queda prohibido tirar líquidos en los botes de basura.</p>
                    </div>
                    
                    <div class="contract-clause">
                        <h4><i class="fas fa-palette"></i> Decoración.</h4>
                        <p>Queda prohibido reventar globos o dañar la decoración instalada.</p>
                    </div>
                </div>
                
                <div class="section">
                    <h3>II. DECORACIÓN DEL SALÓN</h3>
                    <p>Se otorgará 1 hora previa para decoración.</p>
                    <p>Durante este tiempo:</p>
                    <ul>
                        <li>❌ No se permite consumir alcohol</li>
                        <li>❌ No se permite el uso de juegos</li>
                    </ul>
                    <p>Solo se permitirá el acceso a 4 personas máximo.</p>
                    <p>La basura generada deberá retirarse al finalizar la decoración.</p>
                </div>
                
                <div class="section">
                    <h3>III. POLÍTICAS DE CANCELACIÓN Y CAMBIOS</h3>
                    <p>En caso de cancelación por cualquier motivo:</p>
                    <ul>
                        <li>Solo se reembolsará el 50% del anticipo, únicamente si se cancula dentro de los primeros 5 días posteriores a la firma del contrato.</li>
                        <li>El reembolso se realizará en un plazo máximo de 15 días naturales, a la persona que firmó el contrato.</li>
                        <li>Después del día 5, NO habra reembolsos bajo ninguna circunstancia.</li>
                        <li>El cambio de fecha deberá solicitarse dentro de los 10 días posteriores a la firma; de lo contrario se aplicará una penalización de $1,800.00 MXN.</li>
                        <li>El evento solo podrá posponerse hasta 4 meses, sujeto a disponibilidad.</li>
                        <li>Si el número de invitados excede lo pactado, se cobrará un adicional de $<strong>${extraGuestCost.toLocaleString()}</strong> MXN por cada invitado extra.</li>
                    </ul>
                </div>
                
                <div class="section">
                    <h3>IV. CONDICIONES DEL SERVICIO</h3>
                    <div class="contract-clause">
                        <h4><i class="fas fa-exclamation-triangle"></i> Fuerza mayor.</h4>
                        <p>En caso de incendio, sismo, falla eléctrica, motines, contingencias oficiales o causas ajenas al salón, SALÓN AZUL queda liberado de toda responsabilidad.</p>
                    </div>
                    
                    <div class="contract-clause">
                        <h4><i class="fas fa-clock"></i> Duración del evento.</h4>
                        <p>El servicio tiene una duración de 5 horas exactas, conforme a lo permitido por la autoridad municipal.</p>
                        <p>Acceso: 30 minutos antes<br>
                        Retiro: 30 minutos posteriores<br>
                        Cualquier excedente se cobrará como hora extra a $<strong>${extraHourCost.toLocaleString()}</strong> por hora.</p>
                    </div>
                </div>
                
                <div class="section">
                    <h3>V. INFORMACIÓN DEL EVENTO</h3>
                    <table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Nombre del Contratante:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${contractorName}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Domicilio:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${contractorAddress}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Teléfono:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${contractorPhone}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Nombre del Festejado:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${celebrantName}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Fecha del Evento:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${formattedEventDate}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Hora de Inicio:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${startTime} (Máximo 6:00 PM)</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Hora de Término:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${endTime}</td>
                        </tr>
                        ${tableclothInfo ? `
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Cubremantel:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${tablecloth === 'Sí' ? `Sí${tableclothColor ? `, Color: ${tableclothColor}` : ''}` : 'No'}</td>
                        </tr>
                        ` : ''}
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Tipo de Evento:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${eventType}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Servicios Adicionales:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${additionalServices}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Número de Invitados:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${guestsNumber}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Costo Base del Evento:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">$${baseCost.toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Costo por Hora Extra:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">$${extraHourCost.toLocaleString()}/hora</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Total del Contrato:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">$${totalAmount.toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Anticipo Inicial:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">$${advancePayment.toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Pagos Adicionales:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">$${(totalPaid - advancePayment).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Total Pagado:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">$${totalPaid.toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Saldo Pendiente:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">$${balanceDue.toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Método de Pago:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${paymentMethod}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="section signature-section">
                    <h3>VI. ACEPTACIÓN Y FIRMAS</h3>
                    <p>El contratante declara haber leído y aceptado todas las cláusulas del presente contrato.</p>
                    
                    <div style="margin-top: 2rem;">
                        <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 300px; margin: 1rem;">
                                <p><strong>FIRMA DEL CONTRATANTE:</strong></p>
                                <div style="height: 100px; border-bottom: 1px solid #333; margin-top: 1rem; display: flex; align-items: center; justify-content: center;">
                                    ${signatureContractor ? `<img src="${signatureContractor}" alt="Firma del contratante" style="max-height: 80px; max-width: 100%;">` : '_________________________'}
                                </div>
                                <p style="text-align: center; margin-top: 0.5rem;">${contractorName}</p>
                            </div>
                            
                            <div style="flex: 1; min-width: 300px; margin: 1rem;">
                                <p><strong>FIRMA DEL REPRESENTANTE:</strong></p>
                                <div style="height: 100px; border-bottom: 1px solid #333; margin-top: 1rem; display: flex; align-items: center; justify-content: center;">
                                    ${signatureRepresentative ? `<img src="${signatureRepresentative}" alt="Firma del representante" style="max-height: 80px; max-width: 100%;">` : '_________________________'}
                                </div>
                                <p style="text-align: center; margin-top: 0.5rem;">${representativeName}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            preview.innerHTML = contractHTML;
        }
        
        // Guardar contrato
        document.getElementById('createContractForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const requiredFields = [
                'contractorName', 'contractorPhone', 'contractorAddress', 'celebrantName',
                'contractDay', 'contractMonth', 'contractYear', 'representativeName',
                'eventType', 'eventDate', 'guestsNumber', 'startTime', 'endTime',
                'baseCost', 'extraHourCost', 'totalAmount', 'advancePayment', 'paymentMethod'
            ];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showNotification(`El campo "${field.previousElementSibling.textContent.replace('*', '').trim()}" es obligatorio`, 'error');
                    field.focus();
                    return;
                }
            }
            
            const startTime = document.getElementById('startTime').value;
            const maxTime = "18:00";
            if (startTime > maxTime) {
                showNotification('La hora de inicio no puede ser después de las 6:00 PM (18:00)', 'error');
                document.getElementById('startTime').focus();
                return;
            }
            
            const endTime = document.getElementById('endTime').value;
            if (startTime >= endTime) {
                showNotification('La hora de término debe ser posterior a la hora de inicio', 'error');
                document.getElementById('endTime').focus();
                return;
            }
            
            if (!signatureContractor) {
                showNotification('Por favor, guarde la firma del contratante antes de continuar', 'error');
                return;
            }
            
            if (!signatureRepresentative) {
                showNotification('Por favor, guarde la firma del representante antes de continuar', 'error');
                return;
            }
            
            const totalAmount = parseFloat(document.getElementById('totalAmount').value);
            const advancePayment = parseFloat(document.getElementById('advancePayment').value);
            
            if (advancePayment > totalAmount) {
                showNotification('El anticipo no puede ser mayor al total del contrato', 'error');
                return;
            }
            
            const eventDate = document.getElementById('eventDate').value;
            const contractId = document.getElementById('contractId').value;
            const isEditing = document.getElementById('isEditing').value === 'true';
            
            const sameDateContracts = contracts.filter(c => {
                if (isEditing && c.id === parseInt(contractId)) {
                    return false;
                }
                return c.eventDate === eventDate;
            });
            
            if (sameDateContracts.length > 0) {
                const conflictingContract = sameDateContracts[0];
                showDateConflictModal(conflictingContract, eventDate);
                
                window.pendingContractData = getContractFormData();
                
                return;
            }
            
            saveContract();
        });
        
        // Obtener datos del formulario
        function getContractFormData() {
            return {
                contractorName: document.getElementById('contractorName').value,
                contractorPhone: document.getElementById('contractorPhone').value,
                contractorAddress: document.getElementById('contractorAddress').value,
                celebrantName: document.getElementById('celebrantName').value,
                contractDay: document.getElementById('contractDay').value,
                contractMonth: document.getElementById('contractMonth').value,
                contractYear: document.getElementById('contractYear').value,
                representativeName: document.getElementById('representativeName').value,
                eventType: document.getElementById('eventType').value,
                eventDate: document.getElementById('eventDate').value,
                guestsNumber: parseInt(document.getElementById('guestsNumber').value),
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                baseCost: parseFloat(document.getElementById('baseCost').value),
                extraHourCost: parseFloat(document.getElementById('extraHourCost').value),
                additionalServices: document.getElementById('additionalServices').value,
                tablecloth: document.getElementById('tablecloth').value,
                tableclothColor: document.getElementById('tableclothColor').value,
                totalAmount: parseFloat(document.getElementById('totalAmount').value),
                advancePayment: parseFloat(document.getElementById('advancePayment').value),
                balanceDue: parseFloat(document.getElementById('balanceDue').value),
                paymentMethod: document.getElementById('paymentMethod').value,
                alcoholExtraCost: parseFloat(document.getElementById('alcoholExtraCost').value) || 0,
                extraGuestCost: parseFloat(document.getElementById('extraGuestCost').value) || 0,
                signatureContractor: signatureContractor,
                signatureRepresentative: signatureRepresentative,
                additionalPayments: additionalPayments,
                totalPaid: parseFloat(document.getElementById('advancePayment').value) + additionalPayments.reduce((sum, payment) => sum + payment.amount, 0),
                status: document.getElementById('advancePayment').value >= document.getElementById('totalAmount').value * 0.5 ? 'confirmado' : 'pendiente'
            };
        }
        
        // Guardar contrato
        function saveContract(contractData = null) {
            const isEditing = document.getElementById('isEditing').value === 'true';
            const contractId = document.getElementById('contractId').value;
            
            if (!contractData) {
                contractData = getContractFormData();
            }
            
            if (isEditing && contractId) {
                const index = contracts.findIndex(c => c.id === parseInt(contractId));
                if (index !== -1) {
                    contractData.id = parseInt(contractId);
                    contractData.createdAt = contracts[index].createdAt || new Date().toISOString().split('T')[0];
                    
                    if (!contractData.additionalPayments && contracts[index].additionalPayments) {
                        contractData.additionalPayments = contracts[index].additionalPayments;
                    }
                    
                    contracts[index] = contractData;
                    
                    showNotification('Contrato actualizado exitosamente', 'success');
                }
            } else {
                const newContract = {
                    id: Date.now(),
                    createdAt: new Date().toISOString().split('T')[0],
                    ...contractData
                };
                contracts.push(newContract);
                lastCreatedContractId = newContract.id;
                
                document.getElementById('contractIdDisplay').textContent = newContract.id;
                
                showNotification('Contrato creado exitosamente', 'success');
            }
            
            saveData();
            
            loadContractsTable();
            loadStatistics();
            
            document.getElementById('printContractBtn').style.display = 'inline-block';
            document.getElementById('sendWhatsAppBtn').style.display = 'inline-block';
            
            document.getElementById('confirmationMessage').classList.add('show');
            
            if (!isEditing) {
                showNotification('Contrato guardado. Ahora puede imprimirlo o enviarlo por WhatsApp.', 'success');
            }
            
            if (isEditing) {
                cancelEdit();
            }
        }
        
        // Enviar contrato por WhatsApp
        function sendContractViaWhatsApp(contractId) {
            const contract = contracts.find(c => c.id === contractId);
            if (!contract) {
                showNotification('Contrato no encontrado', 'error');
                return;
            }
            
            generatePdfForWhatsApp(contract);
        }
        
        // Agregar pago adicional
        document.getElementById('addPaymentBtn').addEventListener('click', function() {
            const amount = parseFloat(document.getElementById('additionalPaymentAmount').value) || 0;
            const method = document.getElementById('additionalPaymentMethod').value;
            
            if (amount <= 0) {
                showNotification('Ingrese un monto válido', 'error');
                return;
            }
            
            const payment = {
                id: Date.now(),
                date: new Date().toLocaleDateString('es-ES'),
                amount: amount,
                method: method,
                addedAt: new Date().toISOString()
            };
            
            additionalPayments.push(payment);
            
            updatePaymentHistory();
            
            const currentAdvance = parseFloat(document.getElementById('advancePayment').value) || 0;
            const newAdvance = currentAdvance + amount;
            document.getElementById('advancePayment').value = newAdvance;
            
            const total = parseFloat(document.getElementById('totalAmount').value) || 0;
            const balance = Math.max(0, total - newAdvance);
            document.getElementById('balanceDue').value = balance;
            
            updatePaymentDisplay();
            updateContractPreview();
            
            document.getElementById('additionalPaymentAmount').value = '';
            
            showNotification(`Pago adicional de $${amount.toLocaleString()} registrado`, 'success');
            
            sendPaymentNotification(payment);
        });
        
        // Actualizar historial de pagos
        function updatePaymentHistory() {
            const paymentHistoryList = document.getElementById('paymentHistoryList');
            paymentHistoryList.innerHTML = '';
            
            if (additionalPayments.length === 0) {
                paymentHistoryList.innerHTML = '<p style="color: #666; font-style: italic;">No hay pagos adicionales registrados</p>';
                return;
            }
            
            additionalPayments.forEach(payment => {
                const paymentItem = document.createElement('div');
                paymentItem.className = 'payment-history-item';
                paymentItem.innerHTML = `
                    <div>
                        <span class="payment-history-date">${payment.date}</span>
                        <span style="margin-left: 1rem; color: #666;">(${payment.method})</span>
                    </div>
                    <div>
                        <span class="payment-history-amount">$${payment.amount.toLocaleString()}</span>
                        <button class="action-btn delete" style="margin-left: 0.5rem; padding: 0.2rem 0.5rem; font-size: 0.8rem;" onclick="removeAdditionalPayment(${payment.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                paymentHistoryList.appendChild(paymentItem);
            });
        }
        
        // Eliminar pago adicional
        function removeAdditionalPayment(paymentId) {
            if (confirm('¿Está seguro de eliminar este pago?')) {
                additionalPayments = additionalPayments.filter(p => p.id !== paymentId);
                updatePaymentHistory();
                updateContractPreview();
                showNotification('Pago eliminado', 'info');
            }
        }
        
        // Enviar notificación de pago por WhatsApp
        function sendPaymentNotification(payment) {
            const contractorName = document.getElementById('contractorName').value;
            const contractorPhone = document.getElementById('contractorPhone').value;
            const totalPaid = parseFloat(document.getElementById('advancePayment').value) || 0;
            const balanceDue = parseFloat(document.getElementById('balanceDue').value) || 0;
            const eventDate = document.getElementById('eventDate').value;
            
            const formattedDate = new Date(eventDate).toLocaleDateString('es-ES', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            const message = `Hola ${contractorName}, le informamos que se ha registrado un pago adicional de $${payment.amount.toLocaleString()} (${payment.method}) para su evento del ${formattedDate}. Total pagado: $${totalPaid.toLocaleString()}. Saldo pendiente: $${balanceDue.toLocaleString()}. ¡Gracias por su pago!`;
            
            const whatsappUrl = `https://wa.me/52${contractorPhone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
            
            if (confirm('¿Desea enviar un mensaje de WhatsApp al cliente informando del pago?')) {
                window.open(whatsappUrl, '_blank');
            }
        }
        
        // Editar contrato
        function editContract(contractId) {
            const contract = contracts.find(c => c.id === contractId);
            if (!contract) {
                showNotification('Contrato no encontrado', 'error');
                return;
            }
            
            isEditMode = true;
            currentContractId = contractId;
            
            document.getElementById('contractFormTitle').textContent = 'Editar Contrato';
            document.getElementById('contractFormSubtitle').textContent = 'Modifique los datos del contrato existente';
            document.getElementById('submitContractBtn').textContent = 'Actualizar Contrato';
            document.getElementById('contractId').value = contractId;
            document.getElementById('isEditing').value = 'true';
            
            document.getElementById('editPaymentSection').style.display = 'block';
            
            document.getElementById('contractorName').value = contract.contractorName;
            document.getElementById('contractorPhone').value = contract.contractorPhone;
            document.getElementById('contractorAddress').value = contract.contractorAddress;
            document.getElementById('celebrantName').value = contract.celebrantName;
            document.getElementById('contractDay').value = contract.contractDay;
            document.getElementById('contractMonth').value = contract.contractMonth;
            document.getElementById('contractYear').value = contract.contractYear;
            document.getElementById('representativeName').value = contract.representativeName;
            document.getElementById('eventType').value = contract.eventType;
            document.getElementById('eventDate').value = contract.eventDate;
            document.getElementById('guestsNumber').value = contract.guestsNumber;
            document.getElementById('startTime').value = contract.startTime;
            document.getElementById('endTime').value = contract.endTime;
            document.getElementById('baseCost').value = contract.baseCost;
            document.getElementById('extraHourCost').value = contract.extraHourCost;
            document.getElementById('additionalServices').value = contract.additionalServices || '';
            document.getElementById('tablecloth').value = contract.tablecloth || 'No';
            document.getElementById('tableclothColor').value = contract.tableclothColor || '';
            
            if (contract.tablecloth === 'Sí') {
                document.getElementById('tableclothColorGroup').style.display = 'block';
            }
            
            document.getElementById('totalAmount').value = contract.totalAmount;
            document.getElementById('advancePayment').value = contract.advancePayment;
            document.getElementById('balanceDue').value = contract.balanceDue;
            document.getElementById('paymentMethod').value = contract.paymentMethod;
            document.getElementById('alcoholExtraCost').value = contract.alcoholExtraCost || 0;
            document.getElementById('extraGuestCost').value = contract.extraGuestCost || 0;
            
            additionalPayments = contract.additionalPayments || [];
            updatePaymentHistory();
            
            signatureContractor = contract.signatureContractor || null;
            signatureRepresentative = contract.signatureRepresentative || null;
            
            if (signatureContractor) {
                document.getElementById('signaturePreviewContractor').innerHTML = `<img src="${signatureContractor}" alt="Firma del contratante">`;
            }
            if (signatureRepresentative) {
                document.getElementById('signaturePreviewRepresentative').innerHTML = `<img src="${signatureRepresentative}" alt="Firma del representante">`;
            }
            
            document.getElementById('printContractBtn').style.display = 'inline-block';
            document.getElementById('sendWhatsAppBtn').style.display = 'inline-block';
            document.getElementById('confirmationMessage').classList.remove('show');
            
            updateContractPreview();
            updatePaymentDisplay();
            
            checkDateAvailability();
            
            document.querySelectorAll('.admin-nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.admin-section').forEach(section => section.classList.remove('active'));
            document.querySelector('.admin-nav-btn[data-section="createContract"]').classList.add('active');
            document.getElementById('createContractSection').classList.add('active');
            
            showNotification('Modo edición activado. Puede modificar los datos del contrato.', 'info');
        }
        
        // Cancelar edición
        function cancelEdit() {
            isEditMode = false;
            currentContractId = null;
            additionalPayments = [];
            
            document.getElementById('contractFormTitle').textContent = 'Crear Nuevo Contrato';
            document.getElementById('contractFormSubtitle').textContent = 'Complete los datos para generar un nuevo contrato de evento';
            document.getElementById('submitContractBtn').textContent = 'Guardar Contrato';
            document.getElementById('contractId').value = '';
            document.getElementById('isEditing').value = 'false';
            
            document.getElementById('editPaymentSection').style.display = 'none';
            
            resetForm();
        }
        
        // Botón MANDAR POR WHATSAPP
        document.getElementById('sendWhatsAppBtn').addEventListener('click', function() {
            const contractId = document.getElementById('contractId').value || lastCreatedContractId;
            
            if (!contractId) {
                showNotification('No hay contrato para generar PDF. Guarde el contrato primero.', 'error');
                return;
            }
            
            const contract = contracts.find(c => c.id === parseInt(contractId));
            if (!contract) {
                showNotification('Contrato no encontrado', 'error');
                return;
            }
            
            generatePdfForWhatsApp(contract);
        });
        
        // Generar PDF para WhatsApp
        function generatePdfForWhatsApp(contract) {
            try {
                const pdfContent = generatePdfContent(contract);
                const pdfContainer = document.getElementById('pdfContract');
                pdfContainer.innerHTML = pdfContent;
                
                html2canvas(pdfContainer, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    width: pdfContainer.scrollWidth,
                    height: pdfContainer.scrollHeight,
                    windowWidth: pdfContainer.scrollWidth,
                    windowHeight: pdfContainer.scrollHeight
                }).then(canvas => {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210;
                    const pageHeight = 297;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    const fileName = `Contrato_Salon_Azul_${contract.id}_${contract.contractorName.replace(/\s+/g, '_')}.pdf`;
                    pdf.save(fileName);
                    
                    showPdfNotification(contract.contractorName, contract.contractorPhone, fileName);
                    
                    showNotification(`PDF generado y descargado exitosamente. Se abrirá WhatsApp Web en 1 segundo.`, 'success');
                }).catch(error => {
                    console.error('Error al generar PDF:', error);
                    showNotification('Error al generar el PDF: ' + error.message, 'error');
                });
            } catch (error) {
                console.error('Error en generatePdfForWhatsApp:', error);
                showNotification('Error al generar PDF: ' + error.message, 'error');
            }
        }
        
        // Generar contenido HTML para PDF
        function generatePdfContent(contract) {
            let formattedEventDate = contract.eventDate;
            if (contract.eventDate) {
                const dateObj = new Date(contract.eventDate);
                formattedEventDate = dateObj.toLocaleDateString('es-ES', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
            }
            
            const totalPaid = contract.advancePayment + (contract.additionalPayments || []).reduce((sum, payment) => sum + payment.amount, 0);
            
            let tableclothInfo = '';
            if (contract.tablecloth === 'Sí') {
                tableclothInfo = `<tr>
                    <td style="padding: 8px; border: 1px solid #ddd;"><strong>Cubremantel:</strong></td>
                    <td style="padding: 8px; border: 1px solid #ddd;">Sí${contract.tableclothColor ? `, Color: ${contract.tableclothColor}` : ''}</td>
                </tr>`;
            }
            
            return `
                <div style="font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 1.6;">
                    <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #1a237e; padding-bottom: 20px;">
                        <h1 style="margin: 0; color: #1a237e; font-size: 24pt;">SALÓN AZUL</h1>
                        <h2 style="margin: 10px 0; color: #0d47a1; font-size: 18pt;">CONTRATO PRIVADO DE PRESTACIÓN DE SERVICIOS PARA EVENTO SOCIAL</h2>
                        <p style="margin: 10px 0; font-size: 11pt;">El presente contrato establece las condiciones y cláusulas bajo las cuales se llevará a cabo un evento social en las instalaciones del SALÓN AZUL, mismo que ambas partes se obligan a cumplir.</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p>Este contrato se celebra entre:</p>
                        <p><strong>EL PRESTADOR DEL SERVICIO:</strong><br>
                        SALÓN AZUL, representado por: ${contract.representativeName}</p>
                        
                        <p><strong>EL CONTRATANTE:</strong><br>
                        ${contract.contractorName}</p>
                        
                        <p>A los <strong>${contract.contractDay}</strong> días del mes de <strong>${contract.contractMonth}</strong> del año <strong>${contract.contractYear}</strong>, en el domicilio ubicado en Calle Sucesos Nacionales No. 329, Colonia Prensa Nacional, Tlalnepantla de Baz, C.P. 54170, Estado de México, domicilio oficial del Salón Azul.<br>
                        Registro del salón: 531 1422/2013.</p>
                    </div>
                    
                    <div style="margin-bottom: 20px; page-break-inside: avoid;">
                        <h3 style="color: #1a237e; border-bottom: 1px solid #1a237e; padding-bottom: 5px; font-size: 14pt;">I. CLÁUSULAS GENERALES</h3>
                        
                        <p><strong>1. Pago total obligatorio.</strong><br>
                        El contratante se obliga a liquidar el total del arrendamiento con un mínimo de 7 días naturales antes de la fecha del evento. En caso de incumplimiento, el salón se reserva el derecho de cancelar el evento sin reembolso.</p>
                        
                        <p><strong>2. Medidas sanitarias (en caso de contingencia).</strong><br>
                        En caso de contingencia sanitaria decretada por autoridad competente (ej. COVID u otra), no se permitirá el ingreso de grupos musicales, y será obligatorio el uso de cubrebocas, gel antibacterial y toma de temperatura, sin excepción.</p>
                        
                        <p><strong>3. Objetos personales.</strong><br>
                        El Salón Azul no se hace responsable por pérdida, robo u olvido de objetos personales dentro o fuera de las instalaciones.</p>
                        
                        <p><strong>4. Accidentes.</strong><br>
                        El Salón Azul no se hace responsable por accidentes, lesiones o incidentes ocurridos dentro o fuera del inmueble durante el evento.</p>
                        
                        <p><strong>5. Conducta y seguridad.</strong><br>
                        En caso de riñas, enfrentamientos, agresiones verbales o físicas entre invitados, o hacia el personal del salón, el evento será suspendido de inmediato sin derecho a reembolso.</p>
                        
                        <p><strong>6. Menores de edad.</strong><br>
                        Los padres o tutores son totalmente responsable de la supervisión y seguridad de los menores durante todo el evento.</p>
                        
                        <p><strong>7. Uso de juegos.</strong><br>
                        Queda estrictamente prohibido que niños mayores de 8 años utilicen el carrusel u otros juegos no aptos para su edad.</p>
                        
                        <p><strong>8. Daños al inmueble.</strong><br>
                        El contratante se obliga a pagar la reparación total de cualquier daño ocasionado al inmueble, mobiliario, decoración o equipo, independientemente de quién lo haya causado.</p>
                        
                        <p><strong>9. Uso de mobiliario.</strong><br>
                        Queda prohibido pararse, brincar, recostarse o hacer mal uso de sillas, mesas y mobiliario.</p>
                        
                        <p><strong>10. Responsable del evento.</strong><br>
                        El encargado o responsable del evento no podrá retirarse hasta que el evento concluya y todos los asistentes hayan desalojado el salón.</p>
                        
                        <p><strong>11. Bebidas alcohólicas.</strong><br>
                        No se permitirá ingresar más bebidas alcohólicas de las pactadas en el contrato.<br>
                        Por cada botella o cartón adicional se cobrará la cantidad de $<strong>${contract.alcoholExtraCost.toLocaleString()}</strong>.</p>
                        
                        <p><strong>12. Horas extras.</strong><br>
                        Cualquier hora extra se cobrará a razón de $<strong>${contract.extraHourCost.toLocaleString()}</strong> por hora.</p>
                    </div>
                    
                    <div style="margin-bottom: 20px; page-break-inside: avoid;">
                        <p><strong>13. PROHIBICIONES ABSOLUTAS.</strong><br>
                        Queda estrictamente prohibido:</p>
                        <ul>
                            <li>🚫 El uso de pirotecnia, chispas, bengalas, fuegos artificiales o similares</li>
                            <li>🚫 Fumar, vapear o consumir cigarros electrónicos dentro del salón</li>
                            <li>🚫 Ingerir bebidas alcohólicas fuera del inmueble</li>
                        </ul>
                        
                        <p><strong>14. Cocina y limpieza.</strong><br>
                        La cocina deberá entregarse limpia y en orden.<br>
                        Queda prohibido tirar líquidos en los botes de basura.</p>
                        
                        <p><strong>15. Decoración.</strong><br>
                        Queda prohibido reventar globos o dañar la decoración instalada.</p>
                    </div>
                    
                    <div style="margin-bottom: 20px; page-break-inside: avoid;">
                        <h3 style="color: #1a237e; border-bottom: 1px solid #1a237e; padding-bottom: 5px; font-size: 14pt;">II. DECORACIÓN DEL SALÓN</h3>
                        <p>Se otorgará 1 hora previa para decoración.</p>
                        <p>Durante este tiempo:</p>
                        <ul>
                            <li>❌ No se permite consumir alcohol</li>
                            <li>❌ No se permite el uso de juegos</li>
                        </ul>
                        <p>Solo se permitirá el acceso a 4 personas máximo.</p>
                        <p>La basura generada deberá retirarse al finalizar la decoración.</p>
                    </div>
                    
                    <div style="margin-bottom: 20px; page-break-inside: avoid;">
                        <h3 style="color: #1a237e; border-bottom: 1px solid #1a237e; padding-bottom: 5px; font-size: 14pt;">III. POLÍTICAS DE CANCELACIÓN Y CAMBIOS</h3>
                        <p>En caso de cancelación por cualquier motivo:</p>
                        <ul>
                            <li>Solo se reembolsará el 50% del anticipo, únicamente si se cancela dentro de los primeros 5 días posteriores a la firma del contrato.</li>
                            <li>El reembolso se realizará en un plazo máximo de 30 días naturales, a la persona que firmó el contrato.</li>
                            <li>Después del día 5, NO habrá reembolsos bajo ninguna circunstancia.</li>
                            <li>El cambio de fecha deberá solicitarse dentro de los 10 días posteriores a la firma; de lo contrario se aplicará una penalización de $1,800.00 MXN.</li>
                            <li>El evento solo podrá posponerse hasta 4 meses, sujeto a disponibilidad.</li>
                            <li>Si el número de invitados excede lo pactado, se cobrará un adicional de $<strong>${contract.extraGuestCost.toLocaleString()}</strong> MXN por cada invitado extra.</li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 20px; page-break-inside: avoid;">
                        <h3 style="color: #1a237e; border-bottom: 1px solid #1a237e; padding-bottom: 5px; font-size: 14pt;">IV. CONDICIONES DEL SERVICIO</h3>
                        
                        <p><strong>16. Fuerza mayor.</strong><br>
                        En caso de incendio, sismo, falla eléctrica, motines, contingencias oficiales o causas ajenas al salón, SALÓN AZUL queda liberado de toda responsabilidad.</p>
                        
                        <p><strong>17. Duración del evento.</strong><br>
                        El servicio tiene una duración de 5 horas exactas, conforme a lo permitido por la autoridad municipal.</p>
                        <p>Acceso: 30 minutos antes<br>
                        Retiro: 30 minutos posteriores<br>
                        Cualquier excedente se cobrará como hora extra a $<strong>${contract.extraHourCost.toLocaleString()}</strong> por hora.</p>
                    </div>
                    
                    <div style="margin-bottom: 20px; page-break-before: always;">
                        <h3 style="color: #1a237e; border-bottom: 1px solid #1a237e; padding-bottom: 5px; font-size: 14pt;">V. INFORMACIÓN DEL EVENTO</h3>
                        <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Nombre del Contratante:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.contractorName}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Domicilio:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.contractorAddress}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Teléfono:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.contractorPhone}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Nombre del Festejado:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.celebrantName}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Fecha del Evento:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${formattedEventDate}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Hora de Inicio:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.startTime} (Máximo 6:00 PM)</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Hora de Término:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.endTime}</td>
                            </tr>
                            ${tableclothInfo}
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Tipo de Evento:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.eventType}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Servicios Adicionales:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.additionalServices || 'Ninguno'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Número de Invitados:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.guestsNumber}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Costo Base del Evento:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">$${contract.baseCost.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Costo por Hora Extra:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">$${contract.extraHourCost.toLocaleString()}/hora</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Total del Contrato:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">$${contract.totalAmount.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Anticipo Inicial:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">$${contract.advancePayment.toLocaleString()}</td>
                            </tr>
                            ${contract.additionalPayments && contract.additionalPayments.length > 0 ? `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Pagos Adicionales:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">
                                    ${contract.additionalPayments.map(p => `$${p.amount.toLocaleString()} (${p.date}, ${p.method})`).join('<br>')}
                                </td>
                            </tr>
                            ` : ''}
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Total Pagado:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">$${totalPaid.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Saldo Pendiente:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">$${contract.balanceDue.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Método de Pago:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.paymentMethod}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #333; page-break-inside: avoid;">
                        <h3 style="color: #1a237e; border-bottom: 1px solid #1a237e; padding-bottom: 5px; font-size: 14pt;">VI. ACEPTACIÓN Y FIRMAS</h3>
                        <p>El contratante declara haber leído y aceptado todas las cláusulas del presente contrato.</p>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 40px;">
                            <div style="width: 45%;">
                                <p><strong>FIRMA DEL CONTRATANTE:</strong></p>
                                <div style="height: 80px; border-bottom: 1px solid #333; margin-top: 10px; display: flex; align-items: center; justify-content: center;">
                                    ${contract.signatureContractor ? `<img src="${contract.signatureContractor}" alt="Firma del contratante" style="max-height: 70px; max-width: 100%;">` : ''}
                                </div>
                                <p style="text-align: center; margin-top: 10px;">${contract.contractorName}</p>
                            </div>
                            
                            <div style="width: 45%;">
                                <p><strong>FIRMA DEL REPRESENTANTE:</strong></p>
                                <div style="height: 80px; border-bottom: 1px solid #333; margin-top: 10px; display: flex; align-items: center; justify-content: center;">
                                    ${contract.signatureRepresentative ? `<img src="${contract.signatureRepresentative}" alt="Firma del representante" style="max-height: 70px; max-width: 100%;">` : ''}
                                </div>
                                <p style="text-align: center; margin-top: 10px;">${contract.representativeName}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 60px; color: #666; font-size: 10pt;">
                        <p>Salón Azul - Calle Sucesos Nacionales No. 329, Colonia Prensa Nacional, Tlalnepantla de Baz, C.P. 54170, Estado de México</p>
                        <p>Teléfono: +52 55 1234 5678 | Registro: 531 1422/2013</p>
                        <p>ID del Contrato: ${contract.id} | Fecha de creación: ${contract.createdAt}</p>
                    </div>
                </div>
            `;
        }
        
        // Mostrar aviso de PDF
        function showPdfNotification(contractorName, contractorPhone, fileName) {
            document.getElementById('pdfContractorName').textContent = contractorName;
            document.getElementById('pdfContractorPhone').textContent = contractorPhone;
            document.getElementById('pdfFileName').textContent = fileName;
            
            const pdfNotification = document.getElementById('pdfNotification');
            pdfNotification.classList.add('show');
            
            setTimeout(() => {
                openWhatsApp(contractorPhone);
            }, 1000);
            
            setTimeout(() => {
                closePdfNotification();
            }, 5000);
        }
        
        // Abrir WhatsApp
        function openWhatsApp(phone) {
            const whatsappUrl = `https://wa.me/52${phone.replace(/\D/g, '')}`;
            window.open(whatsappUrl, '_blank');
        }
        
        // Cerrar aviso de PDF
        function closePdfNotification() {
            document.getElementById('pdfNotification').classList.remove('show');
        }
        
        // Abrir WhatsApp desde notificación
        document.getElementById('openWhatsAppBtn').addEventListener('click', function() {
            const phone = document.getElementById('pdfContractorPhone').textContent.replace(/\D/g, '');
            openWhatsApp(phone);
            closePdfNotification();
        });
        
        // Resetear formulario
        function resetForm() {
            document.getElementById('createContractForm').reset();
            
            const today = new Date();
            document.getElementById('contractDay').value = today.getDate();
            
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                           'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('contractMonth').value = months[today.getMonth()];
            
            document.getElementById('contractYear').value = '2025';
            document.getElementById('representativeName').value = 'Representante de Salón Azul';
            document.getElementById('eventDate').value = today.toISOString().split('T')[0];
            document.getElementById('startTime').value = '15:00';
            document.getElementById('endTime').value = '20:00';
            document.getElementById('baseCost').value = '';
            document.getElementById('extraHourCost').value = '500';
            document.getElementById('alcoholExtraCost').value = '200';
            document.getElementById('extraGuestCost').value = '450';
            document.getElementById('tablecloth').value = 'No';
            document.getElementById('tableclothColor').value = '';
            document.getElementById('tableclothColorGroup').style.display = 'none';
            
            document.getElementById('dateWarning')?.classList.remove('show');
            document.getElementById('dateAvailable')?.classList.remove('show');
            
            const canvasContractor = document.getElementById('signaturePadContractor');
            if (canvasContractor) {
                const ctxContractor = canvasContractor.getContext('2d');
                ctxContractor.clearRect(0, 0, canvasContractor.width, canvasContractor.height);
                ctxContractor.fillStyle = '#fff';
                ctxContractor.fillRect(0, 0, canvasContractor.width, canvasContractor.height);
            }
            signatureContractor = null;
            document.getElementById('signaturePreviewContractor').innerHTML = '<p style="color: #666; font-style: italic;">Aún no se ha guardado ninguna firma</p>';
            
            const canvasRepresentative = document.getElementById('signaturePadRepresentative');
            if (canvasRepresentative) {
                const ctxRepresentative = canvasRepresentative.getContext('2d');
                ctxRepresentative.clearRect(0, 0, canvasRepresentative.width, canvasRepresentative.height);
                ctxRepresentative.fillStyle = '#fff';
                ctxRepresentative.fillRect(0, 0, canvasRepresentative.width, canvasRepresentative.height);
            }
            signatureRepresentative = null;
            document.getElementById('signaturePreviewRepresentative').innerHTML = '<p style="color: #666; font-style: italic;">Aún no se ha guardado ninguna firma</p>';
            
            additionalPayments = [];
            document.getElementById('paymentHistoryList').innerHTML = '<p style="color: #666; font-style: italic;">No hay pagos adicionales registrados</p>';
            
            document.getElementById('confirmationMessage')?.classList.remove('show');
            document.getElementById('printContractBtn').style.display = 'none';
            document.getElementById('sendWhatsAppBtn').style.display = 'none';
            
            updatePaymentDisplay();
            updateContractPreview();
            
            showNotification('Formulario reiniciado', 'info');
        }
        
        // Cancelar contrato
        document.getElementById('cancelContractBtn').addEventListener('click', function() {
            if (isEditMode) {
                if (confirm('¿Estás seguro de que deseas cancelar la edición? Se perderán los cambios no guardados.')) {
                    cancelEdit();
                }
            } else {
                if (confirm('¿Estás seguro de que deseas cancelar? Se perderán todos los datos ingresados.')) {
                    resetForm();
                }
            }
        });
        
        // ==============================================
        // CALENDARIO MEJORADO - FUNCIONES
        // ==============================================
        
        // Inicializar calendario - VERSIÓN CORREGIDA Y MEJORADA
        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) return;
            
            // Destruir calendario existente si hay uno
            if (calendarInstance) {
                calendarInstance.destroy();
            }
            
            const events = contracts.map(contract => {
                let color = '#2196f3'; // Azul por defecto (pendiente)
                if (contract.status === 'confirmado') color = '#4caf50'; // Verde
                if (contract.status === 'completado') color = '#9c27b0'; // Morado
                if (contract.status === 'cancelado') color = '#f44336'; // Rojo
                
                // Formatear la hora para mostrarla en el evento
                const startTime = contract.startTime || '00:00';
                const eventTitle = `${contract.eventType} - ${contract.contractorName} (${startTime})`;
                
                return {
                    id: contract.id,
                    title: eventTitle,
                    start: contract.eventDate,
                    color: color,
                    extendedProps: {
                        contractorName: contract.contractorName,
                        contractorPhone: contract.contractorPhone,
                        eventType: contract.eventType,
                        guestsNumber: contract.guestsNumber,
                        baseCost: contract.baseCost,
                        status: contract.status,
                        startTime: contract.startTime,
                        endTime: contract.endTime
                    }
                };
            });
            
            calendarInstance = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: events,
                eventClick: function(info) {
                    showCalendarEventDetails(info.event);
                },
                eventDisplay: 'block',
                height: '100%',
                contentHeight: 'auto',
                handleWindowResize: true,
                eventTimeFormat: { // Formato de hora
                    hour: '2-digit',
                    minute: '2-digit',
                    meridiem: false
                }
            });
            
            calendarInstance.render();
        }
        
        // Mostrar detalles del evento del calendario
        function showCalendarEventDetails(event) {
            const contract = contracts.find(c => c.id === parseInt(event.id));
            if (!contract) return;
            
            const modalContent = document.getElementById('calendarEventContent');
            const modalActions = document.getElementById('calendarEventActions');
            
            let statusClass = '';
            let statusText = '';
            
            if (contract.status === 'confirmado') {
                statusClass = 'status-confirmada';
                statusText = 'Confirmado';
            } else if (contract.status === 'completado') {
                statusClass = 'status-completada';
                statusText = 'Completado';
            } else if (contract.status === 'cancelado') {
                statusClass = 'status-cancelada';
                statusText = 'Cancelado';
            } else {
                statusClass = 'status-pendiente';
                statusText = 'Pendiente';
            }
            
            const totalPaid = contract.advancePayment + (contract.additionalPayments || []).reduce((sum, payment) => sum + payment.amount, 0);
            
            let formattedDate = contract.eventDate || 'No definida';
            if (contract.eventDate) {
                const dateObj = new Date(contract.eventDate);
                formattedDate = dateObj.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
            
            modalContent.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: var(--primary); margin-bottom: 0.5rem;">${contract.eventType}</h4>
                    <p><strong>Contratante:</strong> ${contract.contractorName}</p>
                    <p><strong>Teléfono:</strong> ${contract.contractorPhone}</p>
                    <p><strong>Fecha:</strong> ${formattedDate}</p>
                    <p><strong>Hora:</strong> ${contract.startTime || 'No definida'} - ${contract.endTime || 'No definida'}</p>
                    <p><strong>Invitados:</strong> ${contract.guestsNumber}</p>
                    <p><strong>Tipo de Evento:</strong> ${contract.eventType}</p>
                    <p><strong>Estado:</strong> <span class="status-badge ${statusClass}">${statusText}</span></p>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: var(--primary); margin-bottom: 0.5rem;">Información de Pago</h4>
                    <p><strong>Costo Base:</strong> $${contract.baseCost.toLocaleString()}</p>
                    <p><strong>Costo Hora Extra:</strong> $${contract.extraHourCost.toLocaleString()}/hora</p>
                    <p><strong>Total del Contrato:</strong> $${contract.totalAmount.toLocaleString()}</p>
                    <p><strong>Anticipo Inicial:</strong> $${contract.advancePayment.toLocaleString()}</p>
                    ${contract.additionalPayments && contract.additionalPayments.length > 0 ? `
                    <p><strong>Pagos Adicionales:</strong> $${(totalPaid - contract.advancePayment).toLocaleString()}</p>
                    <div style="margin-left: 1rem; font-size: 0.9rem; color: #666;">
                        ${contract.additionalPayments.map(p => `<p>• $${p.amount.toLocaleString()} (${p.date}, ${p.method})</p>`).join('')}
                    </div>
                    ` : ''}
                    <p><strong>Total Pagado:</strong> $${totalPaid.toLocaleString()}</p>
                    <p><strong>Saldo Pendiente:</strong> $${contract.balanceDue.toLocaleString()}</p>
                    <p><strong>Método de Pago:</strong> ${contract.paymentMethod}</p>
                </div>
                
                ${contract.additionalServices ? `
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: var(--primary); margin-bottom: 0.5rem;">Servicios Adicionales</h4>
                    <p>${contract.additionalServices}</p>
                </div>
                ` : ''}
            `;
            
            modalActions.innerHTML = `
                <button class="btn info" onclick="editContract(${contract.id}); closeCalendarModal();">
                    <i class="fas fa-edit"></i> Editar Contrato
                </button>
                <button class="btn success" onclick="addPaymentToContract(${contract.id}); closeCalendarModal();">
                    <i class="fas fa-money-bill-wave"></i> Agregar Pago
                </button>
                <button class="btn whatsapp" onclick="sendContractViaWhatsApp(${contract.id}); closeCalendarModal();">
                    <i class="fab fa-whatsapp"></i> Enviar por WhatsApp
                </button>
                <button class="btn ${contract.status === 'cancelado' ? 'success' : 'warning'}" 
                        onclick="${contract.status === 'cancelado' ? `activateContract(${contract.id})` : `cancelContractFromCalendar(${contract.id})`}; closeCalendarModal();">
                    ${contract.status === 'cancelado' ? '<i class="fas fa-check"></i> Reactivar' : '<i class="fas fa-times"></i> Cancelar'}
                </button>
                <button class="btn delete" onclick="deleteContractFromCalendar(${contract.id}); closeCalendarModal();">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            `;
            
            document.getElementById('calendarEventModal').style.display = 'flex';
        }
        
        // Cerrar modal del calendario
        function closeCalendarModal() {
            document.getElementById('calendarEventModal').style.display = 'none';
        }
        
        // Cancelar contrato desde calendario
        function cancelContractFromCalendar(contractId) {
            if (!confirm('¿Estás seguro de que deseas cancelar este contrato?')) return;
            
            const contractIndex = contracts.findIndex(c => c.id === contractId);
            if (contractIndex === -1) return;
            
            contracts[contractIndex].status = 'cancelado';
            saveData();
            
            loadContractsTable();
            loadStatistics();
            
            showNotification('Contrato cancelado exitosamente', 'success');
        }
        
        // Eliminar contrato desde calendario
        function deleteContractFromCalendar(contractId) {
            if (!confirm('¿Está seguro de eliminar este contrato? Esta acción no se puede deshacer.')) {
                return;
            }
            
            const contractIndex = contracts.findIndex(c => c.id === contractId);
            if (contractIndex === -1) return;
            
            contracts.splice(contractIndex, 1);
            saveData();
            
            loadContractsTable();
            loadStatistics();
            
            showNotification('Contrato eliminado exitosamente', 'success');
        }
        
        // Cerrar modal del calendario al hacer clic en el botón
        document.getElementById('closeCalendarModal').addEventListener('click', closeCalendarModal);
        
        // Cerrar modal del calendario al hacer clic fuera
        document.getElementById('calendarEventModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCalendarModal();
            }
        });
        
        // Cargar tabla de contratos
        function loadContractsTable() {
            const table = document.getElementById('contractsTable');
            if (!table) return;
            
            table.innerHTML = '';
            
            let filteredContracts = [...contracts];
            
            const searchContractor = document.getElementById('searchContractor')?.value.toLowerCase() || '';
            const searchEventType = document.getElementById('searchEventType')?.value || 'all';
            const filterStatus = document.getElementById('filterStatus')?.value || 'all';
            const filterDateRange = document.getElementById('filterDateRange')?.value;
            
            if (searchContractor) {
                filteredContracts = filteredContracts.filter(contract => 
                    contract.contractorName.toLowerCase().includes(searchContractor) ||
                    contract.contractorPhone.includes(searchContractor) ||
                    contract.celebrantName.toLowerCase().includes(searchContractor)
                );
            }
            
            if (searchEventType !== 'all') {
                filteredContracts = filteredContracts.filter(contract => 
                    contract.eventType === searchEventType
                );
            }
            
            if (filterStatus !== 'all') {
                filteredContracts = filteredContracts.filter(contract => 
                    contract.status === filterStatus
                );
            }
            
            if (filterDateRange) {
                const [year, month] = filterDateRange.split('-').map(Number);
                filteredContracts = filteredContracts.filter(contract => {
                    if (!contract.eventDate) return false;
                    const contractDate = new Date(contract.eventDate);
                    return contractDate.getFullYear() === year && 
                           (contractDate.getMonth() + 1) === month;
                });
            }
            
            filteredContracts.sort((a, b) => new Date(b.eventDate || 0) - new Date(a.eventDate || 0));
            
            if (filteredContracts.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="12" style="text-align: center; padding: 2rem; color: #666;">
                            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            No se encontraron contratos con los filtros aplicados
                        </td>
                    </tr>`;
                return;
            }
            
            filteredContracts.forEach(contract => {
                const row = document.createElement('tr');
                row.className = 'contract-row';
                
                const totalPaid = contract.advancePayment + 
                                (contract.additionalPayments || []).reduce((sum, payment) => sum + payment.amount, 0);
                
                let formattedDate = contract.eventDate || 'No definida';
                if (contract.eventDate) {
                    const dateObj = new Date(contract.eventDate);
                    formattedDate = dateObj.toLocaleDateString('es-ES');
                }
                
                let statusClass = 'contract-status ';
                switch(contract.status) {
                    case 'pendiente': statusClass += 'pendiente'; break;
                    case 'confirmado': statusClass += 'confirmado'; break;
                    case 'completado': statusClass += 'completado'; break;
                    case 'cancelado': statusClass += 'cancelado'; break;
                    default: statusClass += 'pendiente';
                }
                
                row.innerHTML = `
                    <td>${contract.id}</td>
                    <td>${contract.contractorName}</td>
                    <td>${contract.contractorPhone}</td>
                    <td>${contract.eventType}</td>
                    <td>${formattedDate}</td>
                    <td>${contract.startTime || ''}</td>
                    <td>$${(contract.baseCost || 0).toLocaleString()}</td>
                    <td>$${(contract.totalAmount || 0).toLocaleString()}</td>
                    <td>$${totalPaid.toLocaleString()}</td>
                    <td>$${(contract.balanceDue || 0).toLocaleString()}</td>
                    <td><span class="${statusClass}">${contract.status || 'pendiente'}</span></td>
                    <td>
                        <button class="action-btn" onclick="viewFullContract(${contract.id})" title="Ver contrato completo">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn info" onclick="editContract(${contract.id})" title="Editar contrato">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn success" onclick="addPaymentToContract(${contract.id})" title="Agregar pago">
                            <i class="fas fa-money-bill-wave"></i>
                        </button>
                        <button class="action-btn whatsapp" onclick="sendContractViaWhatsApp(${contract.id})" title="Enviar contrato por WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <button class="action-btn warning" onclick="markAsCompleted(${contract.id})" title="Marcar como completado">
                            <i class="fas fa-check-circle"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteContract(${contract.id})" title="Eliminar contrato">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                table.appendChild(row);
            });
            
            document.getElementById('quickSearch').value = '';
        }

        // Ver contrato completo
        function viewFullContract(contractId) {
            const contract = contracts.find(c => c.id === contractId);
            if (!contract) return;
            
            const fullContractContent = document.getElementById('fullContractContent');
            fullContractContent.innerHTML = generateContractHTML(contract);
            
            document.getElementById('printFullContractBtn').onclick = function() {
                generatePdfForContract(contractId);
            };
            
            document.getElementById('fullContractModal').style.display = 'flex';
        }
        
        // Generar HTML del contrato para vista completa
        function generateContractHTML(contract) {
            let formattedEventDate = contract.eventDate;
            if (contract.eventDate) {
                const dateObj = new Date(contract.eventDate);
                formattedEventDate = dateObj.toLocaleDateString('es-ES', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
            }
            
            const totalPaid = contract.advancePayment + (contract.additionalPayments || []).reduce((sum, payment) => sum + payment.amount, 0);
            
            return `
                <div style="font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 1.6;">
                    <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #1a237e; padding-bottom: 20px;">
                        <h1 style="margin: 0; color: #1a237e; font-size: 24pt;">SALÓN AZUL</h1>
                        <h2 style="margin: 10px 0; color: #0d47a1; font-size: 18pt;">CONTRATO PRIVADO DE PRESTACIÓN DE SERVICIOS PARA EVENTO SOCIAL</h2>
                        <p style="margin: 10px 0; font-size: 11pt;">ID del Contrato: ${contract.id} | Fecha de creación: ${contract.createdAt}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p>Este contrato se celebra entre:</p>
                        <p><strong>EL PRESTADOR DEL SERVICIO:</strong><br>
                        SALÓN AZUL, representado por: ${contract.representativeName}</p>
                        
                        <p><strong>EL CONTRATANTE:</strong><br>
                        ${contract.contractorName}</p>
                        
                        <p>A los <strong>${contract.contractDay}</strong> días del mes de <strong>${contract.contractMonth}</strong> del año <strong>${contract.contractYear}</strong>, en el domicilio ubicado en Calle Sucesos Nacionales No. 329, Colonia Prensa Nacional, Tlalnepantla de Baz, C.P. 54170, Estado de México, domicilio oficial del Salón Azul.<br>
                        Registro del salón: 531 1422/2013.</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #1a237e; border-bottom: 1px solid #1a237e; padding-bottom: 5px; font-size: 14pt;">INFORMACIÓN DEL EVENTO</h3>
                        <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Nombre del Contratante:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.contractorName}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Domicilio:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.contractorAddress}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Teléfono:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.contractorPhone}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Nombre del Festejado:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.celebrantName}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Fecha del Evento:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${formattedEventDate}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Hora de Inicio:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.startTime} (Máximo 6:00 PM)</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Hora de Término:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.endTime}</td>
                            </tr>
                            ${contract.tablecloth === 'Sí' ? `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Cubremantel:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">Sí${contract.tableclothColor ? `, Color: ${contract.tableclothColor}` : ''}</td>
                            </tr>
                            ` : ''}
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Tipo de Evento:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.eventType}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Servicios Adicionales:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.additionalServices || 'Ninguno'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Número de Invitados:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.guestsNumber}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Costo Base del Evento:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">$${contract.baseCost.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Costo por Hora Extra:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">$${contract.extraHourCost.toLocaleString()}/hora</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Total del Contrato:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">$${contract.totalAmount.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Anticipo Inicial:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">$${contract.advancePayment.toLocaleString()}</td>
                            </tr>
                            ${contract.additionalPayments && contract.additionalPayments.length > 0 ? `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Pagos Adicionales:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">
                                    ${contract.additionalPayments.map(p => `$${p.amount.toLocaleString()} (${p.date}, ${p.method})`).join('<br>')}
                                </td>
                            </tr>
                            ` : ''}
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Total Pagado:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">$${totalPaid.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Saldo Pendiente:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">$${contract.balanceDue.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Método de Pago:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.paymentMethod}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Estado:</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${contract.status}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #333;">
                        <h3 style="color: #1a237e; border-bottom: 1px solid #1a237e; padding-bottom: 5px; font-size: 14pt;">FIRMAS</h3>
                        <p>El contratante declara haber leído y aceptado todas las cláusulas del presente contrato.</p>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 40px;">
                            <div style="width: 45%;">
                                <p><strong>FIRMA DEL CONTRATANTE:</strong></p>
                                <div style="height: 80px; border-bottom: 1px solid #333; margin-top: 10px; display: flex; align-items: center; justify-content: center;">
                                    ${contract.signatureContractor ? `<img src="${contract.signatureContractor}" alt="Firma del contratante" style="max-height: 70px; max-width: 100%;">` : '<p>No hay firma registrada</p>'}
                                </div>
                                <p style="text-align: center; margin-top: 10px;">${contract.contractorName}</p>
                            </div>
                            
                            <div style="width: 45%;">
                                <p><strong>FIRMA DEL REPRESENTANTE:</strong></p>
                                <div style="height: 80px; border-bottom: 1px solid #333; margin-top: 10px; display: flex; align-items: center; justify-content: center;">
                                    ${contract.signatureRepresentative ? `<img src="${contract.signatureRepresentative}" alt="Firma del representante" style="max-height: 70px; max-width: 100%;">` : '<p>No hay firma registrada</p>'}
                                </div>
                                <p style="text-align: center; margin-top: 10px;">${contract.representativeName}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Agregar pago a un contrato
        function addPaymentToContract(contractId) {
            const contract = contracts.find(c => c.id === contractId);
            if (!contract) return;
            
            const totalPaid = contract.advancePayment + (contract.additionalPayments || []).reduce((sum, payment) => sum + payment.amount, 0);
            
            document.getElementById('paymentContractorName').textContent = contract.contractorName;
            document.getElementById('paymentEventType').textContent = contract.eventType;
            document.getElementById('paymentEventDate').textContent = contract.eventDate;
            document.getElementById('paymentTotalAmount').textContent = contract.totalAmount.toLocaleString();
            document.getElementById('paymentPaidSoFar').textContent = totalPaid.toLocaleString();
            document.getElementById('paymentRemainingBalance').textContent = contract.balanceDue.toLocaleString();
            document.getElementById('paymentMaxAmount').textContent = contract.balanceDue.toLocaleString();
            document.getElementById('paymentContractId').value = contractId;
            
            document.getElementById('paymentAmount').setAttribute('max', contract.balanceDue);
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            
            document.getElementById('paymentModal').style.display = 'flex';
        }
        
        // Confirmar pago
        document.getElementById('addPaymentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const contractId = parseInt(document.getElementById('paymentContractId').value);
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const date = document.getElementById('paymentDate').value;
            const method = document.getElementById('paymentMethodModal').value;
            const notes = document.getElementById('paymentNotes').value;
            
            if (amount <= 0) {
                showNotification('El monto debe ser mayor a 0', 'error');
                return;
            }
            
            const contractIndex = contracts.findIndex(c => c.id === contractId);
            if (contractIndex === -1) {
                showNotification('Contrato no encontrado', 'error');
                return;
            }
            
            const contract = contracts[contractIndex];
            const totalPaid = contract.advancePayment + (contract.additionalPayments || []).reduce((sum, payment) => sum + payment.amount, 0);
            const remainingBalance = contract.totalAmount - totalPaid;
            
            if (amount > remainingBalance) {
                showNotification(`El monto no puede exceder el saldo pendiente de $${remainingBalance.toLocaleString()}`, 'error');
                return;
            }
            
            const newPayment = {
                id: Date.now(),
                date: date,
                amount: amount,
                method: method,
                notes: notes,
                addedAt: new Date().toISOString()
            };
            
            if (!contract.additionalPayments) {
                contract.additionalPayments = [];
            }
            
            contract.additionalPayments.push(newPayment);
            
            const newTotalPaid = contract.advancePayment + contract.additionalPayments.reduce((sum, payment) => sum + payment.amount, 0);
            contract.totalPaid = newTotalPaid;
            contract.balanceDue = Math.max(0, contract.totalAmount - newTotalPaid);
            
            if (contract.balanceDue === 0) {
                contract.status = 'completado';
            }
            
            saveData();
            
            document.getElementById('paymentModal').style.display = 'none';
            
            loadContractsTable();
            loadStatistics();
            
            showNotification(`Pago de $${amount.toLocaleString()} registrado exitosamente`, 'success');
            
            sendPaymentConfirmation(contract, newPayment);
        }
        
        // Enviar confirmación de pago por WhatsApp
        function sendPaymentConfirmation(contract, payment) {
            const phone = contract.contractorPhone.replace(/\D/g, '');
            const message = `Hola ${contract.contractorName}, confirmamos que hemos recibido su pago de $${payment.amount.toLocaleString()} (${payment.method}) para su evento del ${contract.eventDate}. Saldo pendiente: $${contract.balanceDue.toLocaleString()}. ¡Gracias por su pago!`;
            
            const whatsappUrl = `https://wa.me/52${phone}?text=${encodeURIComponent(message)}`;
            
            if (confirm('¿Desea enviar un mensaje de WhatsApp al cliente confirmando el pago?')) {
                window.open(whatsappUrl, '_blank');
            }
        }
        
        // Marcar contrato como completado
        function markAsCompleted(contractId) {
            if (!confirm('¿Está seguro de marcar este contrato como completado?')) {
                return;
            }
            
            const contractIndex = contracts.findIndex(c => c.id === contractId);
            if (contractIndex === -1) return;
            
            contracts[contractIndex].status = 'completado';
            
            if (contracts[contractIndex].balanceDue > 0) {
                const currentDate = new Date().toISOString().split('T')[0];
                contracts[contractIndex].additionalPayments = contracts[contractIndex].additionalPayments || [];
                contracts[contractIndex].additionalPayments.push({
                    id: Date.now(),
                    date: currentDate,
                    amount: contracts[contractIndex].balanceDue,
                    method: 'Efectivo',
                    notes: 'Pago final al completar el evento',
                    addedAt: new Date().toISOString()
                });
                
                contracts[contractIndex].balanceDue = 0;
            }
            
            saveData();
            
            loadContractsTable();
            loadStatistics();
            
            showNotification('Contrato marcado como completado', 'success');
        }
        
        // Eliminar contrato
        function deleteContract(contractId) {
            if (!confirm('¿Está seguro de eliminar este contrato? Esta acción no se puede deshacer.')) {
                return;
            }
            
            const contractIndex = contracts.findIndex(c => c.id === contractId);
            if (contractIndex === -1) return;
            
            contracts.splice(contractIndex, 1);
            saveData();
            
            loadContractsTable();
            loadStatistics();
            
            showNotification('Contrato eliminado exitosamente', 'success');
        }
        
        // Cargar estadísticas
        function loadStatistics() {
            const year = parseInt(document.getElementById('statsYear')?.value || '2025');
            const month = document.getElementById('statsMonth')?.value || 'all';
            const status = document.getElementById('statsStatus')?.value || 'completado';
            
            let filteredContracts = contracts.filter(contract => {
                if (!contract.eventDate) return false;
                
                const contractDate = new Date(contract.eventDate);
                const contractYear = contractDate.getFullYear();
                const contractMonth = contractDate.getMonth() + 1;
                
                if (contractYear !== year) return false;
                
                if (month !== 'all' && contractMonth !== parseInt(month)) return false;
                
                if (status !== 'all' && contract.status !== status) return false;
                
                return true;
            });
            
            const totalContracts = filteredContracts.length;
            
            let totalRevenue = 0;
            filteredContracts.forEach(contract => {
                totalRevenue += contract.advancePayment || 0;
                
                if (contract.additionalPayments && contract.additionalPayments.length > 0) {
                    contract.additionalPayments.forEach(payment => {
                        totalRevenue += payment.amount || 0;
                    });
                }
            });
            
            const averageContract = totalContracts > 0 ? totalRevenue / totalContracts : 0;
            
            const completedEvents = filteredContracts.filter(c => c.status === 'completado').length;
            
            if (document.getElementById('totalContracts')) {
                document.getElementById('totalContracts').textContent = totalContracts;
            }
            if (document.getElementById('totalRevenue')) {
                document.getElementById('totalRevenue').textContent = `$${totalRevenue.toLocaleString()}`;
            }
            if (document.getElementById('averageContract')) {
                document.getElementById('averageContract').textContent = `$${averageContract.toFixed(0).toLocaleString()}`;
            }
            if (document.getElementById('completedEvents')) {
                document.getElementById('completedEvents').textContent = completedEvents;
            }
            
            calculateChanges(year, month, filteredContracts);
            generateCharts(filteredContracts, year, month);
            generateMonthlyBreakdown(year, status);
        }
        
        // Calcular cambios porcentuales
        function calculateChanges(year, month, currentContracts) {
            const previousYear = year - 1;
            
            const previousContracts = contracts.filter(contract => {
                if (!contract.eventDate) return false;
                const contractDate = new Date(contract.eventDate);
                return contractDate.getFullYear() === previousYear;
            });
            
            let previousRevenue = 0;
            previousContracts.forEach(contract => {
                const totalPaid = contract.advancePayment + (contract.additionalPayments || []).reduce((sum, payment) => sum + payment.amount, 0);
                previousRevenue += totalPaid;
            });
            
            const currentRevenue = currentContracts.reduce((sum, contract) => {
                const totalPaid = contract.advancePayment + (contract.additionalPayments || []).reduce((s, payment) => s + payment.amount, 0);
                return sum + totalPaid;
            }, 0);
            
            const totalChange = previousContracts.length > 0 ? 
                ((currentContracts.length - previousContracts.length) / previousContracts.length * 100).toFixed(1) : '--';
            
            const revenueChange = previousRevenue > 0 ? 
                ((currentRevenue - previousRevenue) / previousRevenue * 100).toFixed(1) : '--';
            
            if (document.getElementById('contractsChange')) {
                document.getElementById('contractsChange').innerHTML = previousContracts.length > 0 ? 
                    `${totalChange >= 0 ? '+' : ''}${totalChange}%` : '--';
                document.getElementById('contractsChange').className = `change ${totalChange >= 0 ? 'positive' : 'negative'}`;
            }
            
            if (document.getElementById('revenueChange')) {
                document.getElementById('revenueChange').innerHTML = previousRevenue > 0 ? 
                    `${revenueChange >= 0 ? '+' : ''}${revenueChange}%` : '--';
                document.getElementById('revenueChange').className = `change ${revenueChange >= 0 ? 'positive' : 'negative'}`;
            }
            
            const previousAverage = previousContracts.length > 0 ? previousRevenue / previousContracts.length : 0;
            const averageChange = previousAverage > 0 ? 
                ((averageContract - previousAverage) / previousAverage * 100).toFixed(1) : '--';
            
            const previousCompleted = previousContracts.filter(c => c.status === 'completado').length;
            const completedChange = previousCompleted > 0 ? 
                ((completedEvents - previousCompleted) / previousCompleted * 100).toFixed(1) : '--';
            
            if (document.getElementById('averageChange')) {
                document.getElementById('averageChange').innerHTML = previousAverage > 0 ? 
                    `${averageChange >= 0 ? '+' : ''}${averageChange}%` : '--';
                document.getElementById('averageChange').className = `change ${averageChange >= 0 ? 'positive' : 'negative'}`;
            }
            
            if (document.getElementById('completedChange')) {
                document.getElementById('completedChange').innerHTML = previousCompleted > 0 ? 
                    `${completedChange >= 0 ? '+' : ''}${completedChange}%` : '--';
                document.getElementById('completedChange').className = `change ${completedChange >= 0 ? 'positive' : 'negative'}`;
            }
        }
        
        // Generar gráficos
        function generateCharts(filteredContracts, year, month) {
            if (revenueChart) {
                revenueChart.destroy();
            }
            if (statusChart) {
                statusChart.destroy();
            }
            
            const monthlyData = getMonthlyData(year);
            
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                revenueChart = new Chart(revenueCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: monthlyData.months,
                        datasets: [{
                            label: 'Ingresos ($)',
                            data: monthlyData.revenues,
                            backgroundColor: 'rgba(33, 150, 243, 0.7)',
                            borderColor: 'rgba(33, 150, 243, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Ingresos: $' + context.raw.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            const statusCounts = {
                'pendiente': filteredContracts.filter(c => c.status === 'pendiente').length,
                'confirmado': filteredContracts.filter(c => c.status === 'confirmado').length,
                'completado': filteredContracts.filter(c => c.status === 'completado').length,
                'cancelado': filteredContracts.filter(c => c.status === 'cancelado').length
            };
            
            const statusCtx = document.getElementById('statusChart');
            if (statusCtx) {
                statusChart = new Chart(statusCtx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: ['Pendiente', 'Confirmado', 'Completado', 'Cancelado'],
                        datasets: [{
                            data: [
                                statusCounts.pendiente,
                                statusCounts.confirmado,
                                statusCounts.completado,
                                statusCounts.cancelado
                            ],
                            backgroundColor: [
                                'rgba(33, 150, 243, 0.7)',
                                'rgba(76, 175, 80, 0.7)',
                                'rgba(156, 39, 176, 0.7)',
                                'rgba(244, 67, 54, 0.7)'
                            ],
                            borderColor: [
                                'rgba(33, 150, 243, 1)',
                                'rgba(76, 175, 80, 1)',
                                'rgba(156, 39, 176, 1)',
                                'rgba(244, 67, 54, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Obtener datos mensuales
        function getMonthlyData(year) {
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const revenues = new Array(12).fill(0);
            const contractsCount = new Array(12).fill(0);
            
            contracts.forEach(contract => {
                const contractDate = new Date(contract.eventDate);
                const contractYear = contractDate.getFullYear();
                const contractMonth = contractDate.getMonth();
                
                if (contractYear === year) {
                    const totalPaid = contract.advancePayment + (contract.additionalPayments || []).reduce((sum, payment) => sum + payment.amount, 0);
                    
                    revenues[contractMonth] += totalPaid;
                    contractsCount[contractMonth] += 1;
                }
            });
            
            return {
                months: months,
                revenues: revenues,
                contractsCount: contractsCount
            };
        }
        
        // Generar desglose mensual
        function generateMonthlyBreakdown(year, status) {
            const monthlyData = getMonthlyData(year);
            const breakdownBody = document.getElementById('monthlyBreakdownBody');
            if (!breakdownBody) return;
            
            breakdownBody.innerHTML = '';
            
            let yearTotalContracts = 0;
            let yearTotalRevenue = 0;
            
            for (let i = 0; i < 12; i++) {
                const monthContracts = contracts.filter(contract => {
                    const contractDate = new Date(contract.eventDate);
                    const contractYear = contractDate.getFullYear();
                    const contractMonth = contractDate.getMonth();
                    
                    if (contractYear !== year) return false;
                    if (contractMonth !== i) return false;
                    if (status !== 'all' && contract.status !== status) return false;
                    
                    return true;
                });
                
                const monthContractsCount = monthContracts.length;
                
                let monthRevenue = 0;
                
                monthContracts.forEach(contract => {
                    const totalPaid = contract.advancePayment + (contract.additionalPayments || []).reduce((sum, payment) => sum + payment.amount, 0);
                    monthRevenue += totalPaid;
                });
                
                const monthAverage = monthContractsCount > 0 ? monthRevenue / monthContractsCount : 0;
                
                yearTotalContracts += monthContractsCount;
                yearTotalRevenue += monthRevenue;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${monthlyData.months[i]}</td>
                    <td>${monthContractsCount}</td>
                    <td>$${monthRevenue.toLocaleString()}</td>
                    <td>$${monthAverage.toFixed(0).toLocaleString()}</td>
                `;
                breakdownBody.appendChild(row);
            }
            
            const yearAverage = yearTotalContracts > 0 ? yearTotalRevenue / yearTotalContracts : 0;
            
            const totalRow = document.createElement('tr');
            totalRow.style.fontWeight = 'bold';
            totalRow.style.backgroundColor = '#f5f7fa';
            totalRow.innerHTML = `
                <td>TOTAL ${year}</td>
                <td>${yearTotalContracts}</td>
                <td>$${yearTotalRevenue.toLocaleString()}</td>
                <td>$${yearAverage.toFixed(0).toLocaleString()}</td>
            `;
            breakdownBody.appendChild(totalRow);
        }
        
        // Navegación entre secciones del panel
        document.querySelectorAll('.admin-nav-btn').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.admin-nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                this.classList.add('active');
                
                document.querySelectorAll('.admin-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                const sectionId = this.getAttribute('data-section') + 'Section';
                document.getElementById(sectionId).classList.add('active');
                
                if (sectionId === 'calendarSection') {
                    setTimeout(() => {
                        initializeCalendar();
                    }, 100);
                } else if (sectionId === 'viewContractsSection') {
                    loadContractsTable();
                } else if (sectionId === 'statisticsSection') {
                    loadStatistics();
                } else if (sectionId === 'inventorySection') {
                    loadInventory();
                }
            });
        });
        
        // Filtros para contratos
        document.getElementById('applySearchBtn')?.addEventListener('click', function() {
            loadContractsTable();
        });
        
        document.getElementById('clearSearchBtn')?.addEventListener('click', function() {
            document.getElementById('searchContractor').value = '';
            document.getElementById('searchEventType').value = 'all';
            document.getElementById('filterStatus').value = 'all';
            document.getElementById('filterDateRange').value = '';
            loadContractsTable();
        });
        
        // Cargar estadísticas
        document.getElementById('loadStatsBtn')?.addEventListener('click', function() {
            loadStatistics();
        });
        
        // ==================== FUNCIONALIDADES DE INVENTARIO ====================
        
        // Cargar inventario
        function loadInventory() {
            const totalItems = inventory.length;
            const lowStockItems = inventory.filter(item => item.quantity < item.minQuantity).length;
            const totalTables = inventory
                .filter(item => item.category === 'mesa_redonda' || item.category === 'mesa_rectangular')
                .reduce((sum, item) => sum + item.quantity, 0);
            const totalTablecloths = inventory
                .filter(item => item.category === 'mantel' || item.category === 'cubremantel')
                .reduce((sum, item) => sum + item.quantity, 0);
            
            if (document.getElementById('totalItems')) {
                document.getElementById('totalItems').textContent = totalItems;
            }
            if (document.getElementById('lowStockItems')) {
                document.getElementById('lowStockItems').textContent = lowStockItems;
            }
            if (document.getElementById('totalTables')) {
                document.getElementById('totalTables').textContent = totalTables;
            }
            if (document.getElementById('totalTablecloths')) {
                document.getElementById('totalTablecloths').textContent = totalTablecloths;
            }
            
            const inventoryGrid = document.getElementById('inventoryGrid');
            if (!inventoryGrid) return;
            
            inventoryGrid.innerHTML = '';
            
            if (inventory.length === 0) {
                inventoryGrid.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;">No hay artículos en el inventario</p>';
                return;
            }
            
            inventory.sort((a, b) => {
                if (a.category !== b.category) {
                    return a.category.localeCompare(b.category);
                }
                return a.name.localeCompare(b.name);
            });
            
            inventory.forEach(item => {
                const card = document.createElement('div');
                card.className = 'inventory-card';
                
                let icon = 'fas fa-box';
                if (item.category === 'mesa_redonda' || item.category === 'mesa_rectangular') {
                    icon = 'fas fa-table';
                } else if (item.category === 'mantel' || item.category === 'cubremantel') {
                    icon = 'fas fa-tshirt';
                } else if (item.category === 'silla') {
                    icon = 'fas fa-chair';
                } else if (item.category === 'decoracion') {
                    icon = 'fas fa-palette';
                } else if (item.category === 'utensilio') {
                    icon = 'fas fa-utensils';
                }
                
                let stockClass = 'good-stock';
                let stockIndicator = '<span class="stock-indicator stock-good"></span>';
                let stockStatus = 'Suficiente';
                
                if (item.quantity < item.minQuantity) {
                    stockClass = 'low-stock';
                    stockIndicator = '<span class="stock-indicator stock-low"></span>';
                    stockStatus = 'Bajo Stock';
                } else if (item.quantity < item.minQuantity * 2) {
                    stockClass = 'medium-stock';
                    stockIndicator = '<span class="stock-indicator stock-medium"></span>';
                    stockStatus = 'Stock Medio';
                }
                
                const categoryNames = {
                    'mesa_redonda': 'Mesa Redonda',
                    'mesa_rectangular': 'Mesa Rectangular',
                    'mantel': 'Mantel',
                    'cubremantel': 'Cubremantel',
                    'silla': 'Silla',
                    'decoracion': 'Decoración',
                    'utensilio': 'Utensilio',
                    'otros': 'Otros'
                };
                
                const conditionNames = {
                    'excelente': 'Excelente',
                    'bueno': 'Bueno',
                    'regular': 'Regular',
                    'necesita_reparacion': 'Necesita Reparación'
                };
                
                card.innerHTML = `
                    <div class="inventory-header">
                        <i class="${icon}"></i>
                        <h3>${item.name}</h3>
                    </div>
                    
                    <div class="inventory-details">
                        <div class="inventory-item">
                            <span><strong>Categoría:</strong></span>
                            <span>${categoryNames[item.category] || item.category}</span>
                        </div>
                        
                        <div class="inventory-item">
                            <span><strong>Cantidad:</strong></span>
                            <span class="${stockClass}">${item.quantity} (Mín: ${item.minQuantity})</span>
                        </div>
                        
                        <div class="inventory-item">
                            <span><strong>Estado de Stock:</strong></span>
                            <span>${stockIndicator} ${stockStatus}</span>
                        </div>
                        
                        ${item.location ? `
                        <div class="inventory-item">
                            <span><strong>Ubicación:</strong></span>
                            <span>${item.location}</span>
                        </div>
                        ` : ''}
                        
                        ${item.condition ? `
                        <div class="inventory-item">
                            <span><strong>Estado:</strong></span>
                            <span>${conditionNames[item.condition] || item.condition}</span>
                        </div>
                        ` : ''}
                        
                        ${item.description ? `
                        <div class="inventory-item">
                            <span><strong>Descripción:</strong></span>
                            <span>${item.description}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="inventory-actions">
                        <button class="action-btn info" onclick="editInventoryItem(${item.id})">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="action-btn delete" onclick="deleteInventoryItem(${item.id})">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                `;
                
                inventoryGrid.appendChild(card);
            });
        }
        
        // Obtener datos del formulario de inventario
        function getInventoryFormData() {
            return {
                name: document.getElementById('itemName').value,
                category: document.getElementById('itemCategory').value,
                quantity: parseInt(document.getElementById('itemQuantity').value),
                minQuantity: parseInt(document.getElementById('itemMinQuantity').value),
                description: document.getElementById('itemDescription').value,
                location: document.getElementById('itemLocation').value,
                condition: document.getElementById('itemCondition').value,
                notes: document.getElementById('itemNotes').value,
                lastUpdated: new Date().toISOString().split('T')[0]
            };
        }
        
        // Guardar artículo de inventario
        document.getElementById('inventoryForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const requiredFields = ['itemName', 'itemCategory', 'itemQuantity', 'itemMinQuantity'];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showNotification(`El campo "${field.previousElementSibling.textContent.replace('*', '').trim()}" es obligatorio`, 'error');
                    field.focus();
                    return;
                }
            }
            
            const quantity = parseInt(document.getElementById('itemQuantity').value);
            const minQuantity = parseInt(document.getElementById('itemMinQuantity').value);
            
            if (quantity < 0) {
                showNotification('La cantidad no puede ser negativa', 'error');
                document.getElementById('itemQuantity').focus();
                return;
            }
            
            if (minQuantity < 0) {
                showNotification('La cantidad mínima no puede ser negativa', 'error');
                document.getElementById('itemMinQuantity').focus();
                return;
            }
            
            const isEditing = document.getElementById('isEditingInventory').value === 'true';
            const itemId = document.getElementById('inventoryItemId').value;
            
            const itemData = getInventoryFormData();
            
            if (isEditing && itemId) {
                const index = inventory.findIndex(item => item.id === parseInt(itemId));
                if (index !== -1) {
                    itemData.id = parseInt(itemId);
                    inventory[index] = itemData;
                    
                    showNotification('Artículo actualizado exitosamente', 'success');
                }
            } else {
                const newItem = {
                    id: Date.now(),
                    ...itemData
                };
                inventory.push(newItem);
                
                showNotification('Artículo agregado exitosamente', 'success');
            }
            
            saveInventoryData();
            loadInventory();
            resetInventoryForm();
        });
        
        // Editar artículo de inventario
        function editInventoryItem(itemId) {
            const item = inventory.find(i => i.id === itemId);
            if (!item) {
                showNotification('Artículo no encontrado', 'error');
                return;
            }
            
            currentInventoryItemId = itemId;
            
            document.getElementById('saveInventoryBtn').innerHTML = '<i class="fas fa-save"></i> Actualizar Artículo';
            document.getElementById('inventoryItemId').value = itemId;
            document.getElementById('isEditingInventory').value = 'true';
            
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemQuantity').value = item.quantity;
            document.getElementById('itemMinQuantity').value = item.minQuantity;
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('itemLocation').value = item.location || '';
            document.getElementById('itemCondition').value = item.condition || 'bueno';
            document.getElementById('itemNotes').value = item.notes || '';
            
            document.querySelectorAll('.admin-nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.admin-section').forEach(section => section.classList.remove('active'));
            document.querySelector('.admin-nav-btn[data-section="inventory"]').classList.add('active');
            document.getElementById('inventorySection').classList.add('active');
            
            showNotification('Modo edición activado. Puede modificar los datos del artículo.', 'info');
        }
        
        // Eliminar artículo de inventario
        function deleteInventoryItem(itemId) {
            if (!confirm('¿Está seguro de eliminar este artículo del inventario?')) {
                return;
            }
            
            const index = inventory.findIndex(item => item.id === itemId);
            if (index !== -1) {
                inventory.splice(index, 1);
                saveInventoryData();
                loadInventory();
                showNotification('Artículo eliminado exitosamente', 'success');
            }
        }
        
        // Cancelar edición de inventario
        document.getElementById('cancelInventoryBtn')?.addEventListener('click', function() {
            resetInventoryForm();
        });
        
        // Resetear formulario de inventario
        function resetInventoryForm() {
            document.getElementById('inventoryForm').reset();
            document.getElementById('saveInventoryBtn').innerHTML = '<i class="fas fa-save"></i> Guardar Artículo';
            document.getElementById('inventoryItemId').value = '';
            document.getElementById('isEditingInventory').value = 'false';
            currentInventoryItemId = null;
            
            document.getElementById('itemCondition').value = 'bueno';
        }
        
        // ==============================================
        // MANEJO DE MODALES
        // ==============================================
        
        // Cerrar modales
        document.getElementById('closeDateConflictModal')?.addEventListener('click', function() {
            document.getElementById('dateConflictModal').style.display = 'none';
        });
        
        document.getElementById('closePaymentModal')?.addEventListener('click', function() {
            document.getElementById('paymentModal').style.display = 'none';
        });
        
        document.getElementById('closeFullContractModal')?.addEventListener('click', function() {
            document.getElementById('fullContractModal').style.display = 'none';
        });
        
        document.getElementById('closeFullContractBtn')?.addEventListener('click', function() {
            document.getElementById('fullContractModal').style.display = 'none';
        });
        
        document.getElementById('cancelPaymentBtn')?.addEventListener('click', function() {
            document.getElementById('paymentModal').style.display = 'none';
        });
        
        // Confirmar guardado con conflicto de fecha
        document.getElementById('confirmSaveWithConflict')?.addEventListener('click', function() {
            document.getElementById('dateConflictModal').style.display = 'none';
            if (window.pendingContractData) {
                saveContract(window.pendingContractData);
                window.pendingContractData = null;
            }
        });
        
        // Cancelar guardado con conflicto de fecha
        document.getElementById('cancelSaveWithConflict')?.addEventListener('click', function() {
            document.getElementById('dateConflictModal').style.display = 'none';
            window.pendingContractData = null;
            document.getElementById('eventDate').focus();
        });
        
        // Cerrar aviso de PDF
        document.getElementById('closePdfNotificationBtn')?.addEventListener('click', function() {
            closePdfNotification();
        });
        
        // Cerrar modales al hacer clic fuera
        document.getElementById('dateConflictModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
                window.pendingContractData = null;
            }
        });
        
        document.getElementById('paymentModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });
        
        document.getElementById('fullContractModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });
        
        // ==============================================
        // INICIALIZACIÓN DE LA PÁGINA
        // ==============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Poner foco en el campo de usuario
            document.getElementById('username').focus();
            
            // No mostrar credenciales en consola por seguridad
            console.log('Sistema de Salón Azul cargado correctamente');
            console.log('Credenciales: Usuario: hiram2009');
        });
    </script>
</body>
</html>
